<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„ØµÙŠØ§Ù†Ø© Ø§Ù„Ù…ÙˆØ­Ø¯Ø©</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root { --primary: #4e54c8; --glass-bg: rgba(255, 255, 255, 0.98); }
        * { box-sizing: border-box; font-family: 'Tajawal', sans-serif; -webkit-tap-highlight-color: transparent; }
        
        body {
            margin: 0;
            background: url('https://a.top4top.io/p_36115ao3o1.jpg') no-repeat center center fixed;
            background-size: cover;
            display: flex; justify-content: center; align-items: center; min-height: 100vh; padding: 20px;
        }
        body::before { content: ''; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: -1; }

        .container-glass {
            width: 100%; max-width: 450px;
            background: var(--glass-bg); border-radius: 25px; padding: 30px;
            box-shadow: 0 15px 40px rgba(0,0,0,0.4); backdrop-filter: blur(15px);
            animation: fadeIn 0.5s ease-out; position: relative;
            max-height: 90vh; overflow-y: auto;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .hidden { display: none !important; }

        /* Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ */
        #splashScreen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #fff; z-index: 9999; display: flex; flex-direction: column;
            align-items: center; justify-content: center; transition: opacity 0.5s;
        }

        /* Ø§Ù„Ù†ØµÙˆØµ ÙˆØ§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ† */
        .header-text { text-align: center; margin-bottom: 25px; }
        .header-text h2 { margin: 0; color: #333; font-size: 24px; font-weight: 800; }
        .header-text p { margin: 5px 0 0; color: #666; font-size: 14px; }
        
        /* Ø§Ù„Ø­Ù‚ÙˆÙ„ */
        .input-box { width: 100%; padding: 15px; border-radius: 12px; border: 1px solid #ddd; margin-bottom: 15px; font-size: 15px; background: #fff; transition: 0.3s; }
        .input-box:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(78, 84, 200, 0.1); }
        
        .action-btn {
            width: 100%; padding: 16px; border: none; border-radius: 12px;
            background: var(--primary); color: white; font-weight: bold; font-size: 16px; cursor: pointer;
            box-shadow: 0 5px 20px rgba(78, 84, 200, 0.3); transition: 0.2s;
        }
        .action-btn:active { transform: scale(0.98); }
        .action-btn:disabled { background: #ccc; cursor: not-allowed; }

        /* ØªØ¨ÙˆÙŠØ¨Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„/Ø§Ù„ØªØ³Ø¬ÙŠÙ„ */
        .auth-tabs { display: flex; background: #eee; padding: 5px; border-radius: 15px; margin-bottom: 25px; }
        .tab { flex: 1; text-align: center; padding: 10px; border-radius: 10px; cursor: pointer; font-weight: bold; color: #666; transition: 0.3s; }
        .tab.active { background: #fff; color: var(--primary); shadow: 0 2px 10px rgba(0,0,0,0.1); }

        /* Ø®Ø§Ù†Ø© Ø§Ù„Ù‡Ø§ØªÙ */
        .phone-container { display: flex; align-items: center; gap: 10px; direction: ltr; margin-bottom: 15px; }
        .country-code { background: #eee; padding: 15px; border-radius: 12px; font-weight: bold; color: #333; }
        .phone-input { flex: 1; padding: 15px; border-radius: 12px; border: 1px solid #ddd; font-size: 16px; outline: none; }
        
        /* Ù…ØªØ·Ù„Ø¨Ø§Øª ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± */
        .password-requirements { font-size: 11px; color: #777; margin-bottom: 15px; text-align: right; background: #f9f9f9; padding: 10px; border-radius: 8px; border-right: 3px solid #ccc; }
        .valid { color: green; font-weight: bold; }
        .invalid { color: red; }

        /* Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¯ÙˆØ± */
        .role-selector { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-bottom: 20px; }
        .role-card { padding: 15px 5px; border-radius: 12px; text-align: center; cursor: pointer; border: 2px solid transparent; background: #f8f9fa; transition: 0.3s; display: flex; flex-direction: column; align-items: center; }
        .role-card.active { border-color: var(--primary); background: #eef2ff; color: var(--primary); font-weight: bold; }
        .role-card i { font-size: 24px; margin-bottom: 5px; }

        /* Ø¨Ù‚ÙŠØ© Ø§Ù„Ø¹Ù†Ø§ØµØ± */
        .avatar-upload { width: 100px; height: 100px; margin: 0 auto 20px; border-radius: 50%; background: #eee; border: 3px solid white; display: flex; align-items: center; justify-content: center; cursor: pointer; overflow: hidden; }
        .avatar-upload img { width: 100%; height: 100%; object-fit: cover; }
        
        /* Ø³ØªØ§ÙŠÙ„ Ø§Ù„Ù…ÙˆØ¸Ù ÙˆØ§Ù„Ù…Ø´Ø±Ù */
        .image-upload-area { border: 2px dashed #999; padding: 15px; text-align: center; border-radius: 15px; margin-bottom: 15px; cursor: pointer; background: rgba(255,255,255,0.6); }
        .gallery { display:flex; flex-wrap:wrap; gap: 8px; margin-bottom: 10px; }
        .gallery img { width: 60px; height: 60px; border-radius: 8px; object-fit: cover; border: 1px solid #ddd; }
        
        .report-card { background: #fff; border-radius: 15px; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); border: 1px solid #eee; }
        .status-badge { padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: bold; }
        .status-new { background: #e3f2fd; color: #1976d2; }
    </style>
</head>
<body>

    <div id="splashScreen">
        <i class="fas fa-lock fa-spin fa-3x" style="color: var(--primary); margin-bottom: 20px;"></i>
        <h3>Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„ØµÙŠØ§Ù†Ø© Ø§Ù„Ø¢Ù…Ù†Ø©</h3>
    </div>

    <div id="authScreen" class="container-glass hidden">
        <div class="header-text"><h2>Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„ØµÙŠØ§Ù†Ø© ğŸ› ï¸</h2></div>

        <div class="auth-tabs">
            <div class="tab active" onclick="switchTab('login')">ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„</div>
            <div class="tab" onclick="switchTab('register')">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯</div>
        </div>

        <div id="loginForm">
            <label style="font-weight: bold; display: block; margin-bottom: 8px;">Ø±Ù‚Ù… Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„</label>
            <div class="phone-container">
                <div class="country-code"><span>ğŸ‡ªğŸ‡¬</span> +20</div>
                <input type="tel" id="loginPhone" class="phone-input" placeholder="10xxxxxxxx">
            </div>

            <label style="font-weight: bold; display: block; margin-bottom: 8px;">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
            <input type="password" id="loginPass" class="input-box" placeholder="********">

            <button class="action-btn" onclick="loginUser()">Ø¯Ø®ÙˆÙ„ Ø¢Ù…Ù† ğŸ”</button>
            <p id="loginStatus" style="text-align: center; color: red; margin-top: 10px;"></p>
        </div>

        <div id="registerForm" class="hidden">
            
            <div id="stepRole">
                <p style="text-align:center; font-weight:bold; margin-bottom:15px;">Ø§Ø®ØªØ± ÙˆØ¸ÙŠÙØªÙƒ:</p>
                <div class="role-selector">
                    <div class="role-card" onclick="selectRole('employee', this)"><i class="fas fa-user-tie"></i><span>Ù…ÙˆØ¸Ù</span></div>
                    <div class="role-card" onclick="selectRole('supervisor', this)"><i class="fas fa-user-shield"></i><span>Ù…Ø´Ø±Ù</span></div>
                    <div class="role-card" onclick="selectRole('technician', this)"><i class="fas fa-tools"></i><span>ÙÙ†ÙŠ</span></div>
                </div>
            </div>

            <div id="stepPhone">
                <label style="font-weight: bold; display: block; margin-bottom: 8px;">Ø±Ù‚Ù… Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ Ù„Ù„ØªÙØ¹ÙŠÙ„</label>
                <div class="phone-container">
                    <div class="country-code"><span>ğŸ‡ªğŸ‡¬</span> +20</div>
                    <input type="tel" id="regPhone" class="phone-input" placeholder="10xxxxxxxx">
                </div>
                <div id="recaptcha-container"></div>
                
                <button id="sendOtpBtn" class="action-btn" onclick="sendOtp()" disabled style="opacity: 0.6; margin-top: 10px;">Ø¥Ø±Ø³Ø§Ù„ ÙƒÙˆØ¯ Ø§Ù„ØªØ­Ù‚Ù‚</button>
                
                <div id="otpInputGroup" style="display: none; margin-top: 15px;">
                    <input type="number" id="otpCode" class="input-box" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„ÙƒÙˆØ¯ (6 Ø£Ø±Ù‚Ø§Ù…)" style="text-align: center; letter-spacing: 3px;">
                    <button class="action-btn" style="background: green;" onclick="verifyOtp()">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø±Ù‚Ù…</button>
                </div>
            </div>

            <div id="stepProfile" class="hidden" style="margin-top: 20px; border-top: 1px solid #ddd; padding-top: 20px;">
                <h3 style="text-align: center; margin-top: 0;">Ø¥Ù†Ø´Ø§Ø¡ ÙƒÙ„Ù…Ø© Ø³Ø± Ù‚ÙˆÙŠØ©</h3>
                
                <input type="password" id="regPass" class="input-box" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©" oninput="checkPassStrength()">
                <div class="password-requirements" id="passStrength">
                    ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† 6 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„
                </div>

                <h3 style="text-align: center;">Ø¨ÙŠØ§Ù†Ø§ØªÙƒ</h3>
                <input type="text" id="fullName" class="input-box" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„">
                <input type="text" id="workPlace" class="input-box" placeholder="Ù…ÙƒØ§Ù† Ø§Ù„Ø¹Ù…Ù„ (Ø§Ù„ÙƒÙ„ÙŠØ©/Ø§Ù„Ù…Ø¨Ù†Ù‰)">
                
                <button class="action-btn" onclick="completeRegistration()">Ø¥ØªÙ…Ø§Ù… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ âœ…</button>
            </div>

            <p id="regStatus" style="text-align: center; color: red; margin-top: 10px;"></p>
        </div>
    </div>

    <div id="appScreen" class="container-glass hidden">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <div style="display: flex; align-items: center; gap: 10px;">
                <img id="headerAvatar" src="https://cdn-icons-png.flaticon.com/512/3135/3135715.png" style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover;">
                <div>
                    <h3 style="margin: 0; font-size: 16px;" id="welcomeName"></h3>
                    <span id="roleBadge" style="font-size: 11px; background: #eef2ff; color: var(--primary); padding: 2px 8px; border-radius: 10px;"></span>
                </div>
            </div>
            <button onclick="logout()" style="background: #fee; border: none; color: #d32f2f; padding: 5px 10px; border-radius: 5px; cursor: pointer;">Ø®Ø±ÙˆØ¬</button>
        </div>
        <hr style="border:0; border-top:1px solid #eee; margin-bottom:20px;">

        <div id="employeeView" class="hidden">
            <h3 style="margin: 0 0 10px 0;">ØªØ³Ø¬ÙŠÙ„ Ø¨Ù„Ø§Øº Ø¬Ø¯ÙŠØ¯</h3>
            <div class="image-upload-area" onclick="document.getElementById('camInput').click()">
                <i class="fas fa-camera fa-2x" style="color: #555;"></i><p>ØµÙˆØ± Ø§Ù„Ø¹Ø·Ù„</p>
            </div>
            <div id="gallery" class="gallery"></div>
            <input type="file" id="camInput" multiple accept="image/*" style="display:none" onchange="previewImages(this)">
            <input type="text" id="loc" class="input-box" placeholder="Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¹Ø·Ù„ Ø¨Ø§Ù„ØªÙØµÙŠÙ„">
            <textarea id="desc" class="input-box" rows="3" placeholder="ÙˆØµÙ Ø§Ù„Ù…Ø´ÙƒÙ„Ø©..."></textarea>
            <button class="action-btn" onclick="sendReport()">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨Ù„Ø§Øº</button>
            <p id="empStatus" style="text-align: center; margin-top: 10px;"></p>
        </div>

        <div id="supervisorView" class="hidden">
            <h3 style="margin: 0 0 15px 0;">Ø§Ù„ÙˆØ§Ø±Ø¯ (Ø§Ù„Ø·Ù„Ø¨Ø§Øª)</h3>
            <div id="reportsList"><p style="text-align: center; color: #777;">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, RecaptchaVerifier, signInWithPhoneNumber, createUserWithEmailAndPassword, signInWithEmailAndPassword, updateProfile } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, collection, addDoc, onSnapshot, query, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBojgV1qxSkf16W1gMMjuKm9zF4daDEaFs",
            authDomain: "nursing-attendance.firebaseapp.com",
            databaseURL: "https://nursing-attendance-default-rtdb.firebaseio.com",
            projectId: "nursing-attendance",
            storageBucket: "nursing-attendance.firebasestorage.app",
            messagingSenderId: "935107068390",
            appId: "1:935107068390:web:60c1dad67bfc9125191627"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);
        auth.languageCode = 'ar';

        let selectedRole = '';
        let verifiedPhone = ''; // Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø°ÙŠ ØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù†Ù‡

        // --- 1. Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª ÙˆØ§Ù„ØªØ´ØºÙŠÙ„ ---
        window.onload = function() {
            // Ù‡Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„ Ø¨Ø§Ù„ÙØ¹Ù„ØŸ (Ø¯Ø®ÙˆÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠ)
            auth.onAuthStateChanged(async (user) => {
                if (user) {
                    const docSnap = await getDoc(doc(db, "users", user.uid));
                    if (docSnap.exists()) showApp(docSnap.data());
                } else {
                    document.getElementById('splashScreen').style.display = 'none';
                    document.getElementById('authScreen').classList.remove('hidden');
                }
            });
        };

        window.switchTab = (tab) => {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            if (tab === 'login') {
                document.querySelectorAll('.tab')[0].classList.add('active');
                document.getElementById('loginForm').classList.remove('hidden');
                document.getElementById('registerForm').classList.add('hidden');
            } else {
                document.querySelectorAll('.tab')[1].classList.add('active');
                document.getElementById('loginForm').classList.add('hidden');
                document.getElementById('registerForm').classList.remove('hidden');
                
                // ØªØ¬Ù‡ÙŠØ² Ø§Ù„ÙƒØ§Ø¨ØªØ´Ø§ Ù„Ù„ØªØ³Ø¬ÙŠÙ„
                if (!window.recaptchaVerifier) {
                    window.recaptchaVerifier = new RecaptchaVerifier(auth, 'recaptcha-container', { 'size': 'normal' });
                    recaptchaVerifier.render();
                }
            }
        };

        // --- 2. Ø¹Ù…Ù„ÙŠØ© Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯ (Register) ---
        window.selectRole = (role, el) => {
            selectedRole = role;
            document.querySelectorAll('.role-card').forEach(c => c.classList.remove('active'));
            el.classList.add('active');
            // ØªÙØ¹ÙŠÙ„ Ø²Ø± Ø§Ù„Ø¥Ø±Ø³Ø§Ù„
            document.getElementById('sendOtpBtn').disabled = false;
            document.getElementById('sendOtpBtn').style.opacity = "1";
        };

        window.sendOtp = () => {
            let raw = document.getElementById('regPhone').value.trim();
            if (raw.startsWith('0')) raw = raw.substring(1);
            verifiedPhone = '+20' + raw;
            
            const status = document.getElementById('regStatus');
            status.innerText = "Ø¬Ø§Ø±ÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ù…Ø²...";
            
            signInWithPhoneNumber(auth, verifiedPhone, window.recaptchaVerifier)
                .then((result) => {
                    window.confirmationResult = result;
                    status.innerText = "ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ âœ…";
                    status.style.color = "green";
                    document.getElementById('otpInputGroup').style.display = 'block';
                    document.getElementById('sendOtpBtn').style.display = 'none';
                    document.getElementById('recaptcha-container').style.display = 'none';
                }).catch((error) => status.innerText = error.message);
        };

        window.verifyOtp = () => {
            const code = document.getElementById('otpCode').value;
            window.confirmationResult.confirm(code).then(() => {
                // Ù†Ø¬Ø­ Ø§Ù„ØªØ­Ù‚Ù‚! Ø§Ù„Ø¢Ù† Ù†Ø¸Ù‡Ø± Ø®Ø§Ù†Ø© ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±
                document.getElementById('stepPhone').classList.add('hidden');
                document.getElementById('stepRole').classList.add('hidden');
                document.getElementById('stepProfile').classList.remove('hidden');
                document.getElementById('regStatus').innerText = "";
                alert("ØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø±Ù‚Ù… Ø¨Ù†Ø¬Ø§Ø­! ÙŠØ±Ø¬Ù‰ ØªØ¹ÙŠÙŠÙ† ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ±.");
            }).catch(() => alert("Ø§Ù„ÙƒÙˆØ¯ Ø®Ø·Ø£"));
        };

        window.checkPassStrength = () => {
            const pass = document.getElementById('regPass').value;
            const msg = document.getElementById('passStrength');
            if(pass.length >= 6) { msg.innerText = "ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù…Ù‚Ø¨ÙˆÙ„Ø© âœ…"; msg.className = "password-requirements valid"; }
            else { msg.innerText = "ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† 6 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„"; msg.className = "password-requirements invalid"; }
        };

        // Ø§Ù„Ø®Ø·ÙˆØ© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©: Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø¨Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ Ø§Ù„ÙˆÙ‡Ù…ÙŠ (Ø§Ù„Ø±Ù‚Ù… + @app.com)
        window.completeRegistration = async () => {
            const pass = document.getElementById('regPass').value;
            const name = document.getElementById('fullName').value;
            const work = document.getElementById('workPlace').value;
            
            if(pass.length < 6 || !name || !work) { alert("Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª"); return; }
            
            const fakeEmail = verifiedPhone.replace('+', '') + "@maintenance.app"; // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø±Ù‚Ù… Ù„Ø¥ÙŠÙ…ÙŠÙ„

            try {
                // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ ÙØ§ÙŠØ±Ø¨ÙŠØ³
                // Ù…Ù„Ø§Ø­Ø¸Ø©: Ù†Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø§ÙŠÙ…ÙŠÙ„ Ø§Ù„ÙˆÙ‡Ù…ÙŠ Ù„Ø£Ù† ÙØ§ÙŠØ±Ø¨ÙŠØ³ ÙŠØªØ·Ù„Ø¨ Ø°Ù„Ùƒ Ù„ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±
                const userCredential = await createUserWithEmailAndPassword(auth, fakeEmail, pass);
                const user = userCredential.user;

                // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                const userData = {
                    uid: user.uid,
                    phone: verifiedPhone,
                    role: selectedRole,
                    name: name,
                    work: work,
                    avatar: "https://cdn-icons-png.flaticon.com/512/3135/3135715.png"
                };
                
                await setDoc(doc(db, "users", user.uid), userData);
                showApp(userData); // Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø¨Ø§Ø´Ø±

            } catch (error) {
                console.error(error);
                if(error.code === 'auth/email-already-in-use') alert("Ù‡Ø°Ø§ Ø§Ù„Ø±Ù‚Ù… Ù…Ø³Ø¬Ù„ Ø¨Ø§Ù„ÙØ¹Ù„! Ø­Ø§ÙˆÙ„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„.");
                else alert("Ø­Ø¯Ø« Ø®Ø·Ø£: " + error.message);
            }
        };


        // --- 3. Ø¹Ù…Ù„ÙŠØ© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ (Login) ---
        window.loginUser = async () => {
            let raw = document.getElementById('loginPhone').value.trim();
            const pass = document.getElementById('loginPass').value;
            
            if (raw.startsWith('0')) raw = raw.substring(1);
            const fullPhone = '+20' + raw;
            const fakeEmail = fullPhone.replace('+', '') + "@maintenance.app";

            const status = document.getElementById('loginStatus');
            status.innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚...";

            try {
                const userCredential = await signInWithEmailAndPassword(auth, fakeEmail, pass);
                // Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø³ØªØ£ØªÙŠ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¹Ø¨Ø± onAuthStateChanged
            } catch (error) {
                console.error(error);
                status.innerText = "Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø© âŒ";
            }
        };

        // --- 4. Ø¹Ø±Ø¶ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ---
        function showApp(userData) {
            document.getElementById('splashScreen').style.display = 'none';
            document.getElementById('authScreen').classList.add('hidden');
            document.getElementById('appScreen').classList.remove('hidden');

            document.getElementById('welcomeName').innerText = userData.name;
            let roleTxt = userData.role === 'supervisor' ? "Ù…Ø´Ø±Ù" : (userData.role === 'technician' ? "ÙÙ†ÙŠ" : "Ù…ÙˆØ¸Ù");
            document.getElementById('roleBadge').innerText = roleTxt;

            if (userData.role === 'employee') {
                document.getElementById('employeeView').classList.remove('hidden');
                document.getElementById('supervisorView').classList.add('hidden');
            } else if (userData.role === 'supervisor') {
                document.getElementById('employeeView').classList.add('hidden');
                document.getElementById('supervisorView').classList.remove('hidden');
                loadReports();
            }
        }

        // --- ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ù…ÙˆØ¸Ù ---
        window.previewImages = (input) => {
            const g = document.getElementById('gallery'); g.innerHTML = "";
            for(let f of input.files) {
                let i = document.createElement('img'); i.src = URL.createObjectURL(f); g.appendChild(i);
            }
        };

        window.sendReport = async () => {
            const btn = document.querySelector('#employeeView .action-btn');
            const status = document.getElementById('empStatus');
            const currentUser = auth.currentUser;
            const desc = document.getElementById('desc').value;

            if(!desc) { alert("Ø§ÙƒØªØ¨ Ø§Ù„ÙˆØµÙ"); return; }
            btn.disabled = true; status.innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø±ÙØ¹...";

            try {
                const userSnap = await getDoc(doc(db, "users", currentUser.uid));
                const userData = userSnap.data();

                let urls = [];
                const files = document.getElementById('camInput').files;
                for(let f of files) {
                    const r = ref(storage, 'reports/'+Date.now()+'_'+f.name);
                    await uploadBytes(r, f);
                    urls.push(await getDownloadURL(r));
                }

                await addDoc(collection(db, "maintenance_reports"), {
                    uid: currentUser.uid,
                    name: userData.name,
                    userWork: userData.work,
                    desc: desc,
                    loc: document.getElementById('loc').value,
                    images: urls,
                    status: 'new',
                    timestamp: serverTimestamp()
                });

                status.innerText = "ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ âœ…";
                setTimeout(() => { 
                    btn.disabled = false; status.innerText = ""; document.getElementById('desc').value = ""; 
                }, 2000);
            } catch(e) { console.error(e); btn.disabled = false; status.innerText = "Ø®Ø·Ø£"; }
        };

        function loadReports() {
            const listDiv = document.getElementById('reportsList');
            const q = query(collection(db, "maintenance_reports"), orderBy("timestamp", "desc"));
            onSnapshot(q, (snapshot) => {
                listDiv.innerHTML = "";
                if (snapshot.empty) { listDiv.innerHTML = "<p style='text-align:center'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨Ù„Ø§ØºØ§Øª</p>"; return; }
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    let imgs = data.images ? data.images.map(u => `<a href="${u}" target="_blank"><img src="${u}" style="width:50px;height:50px;border-radius:5px;margin:2px;"></a>`).join('') : '';
                    let card = `<div class="report-card">
                        <div style="font-weight:bold">${data.name} <span class="status-badge status-new">${data.status}</span></div>
                        <div style="font-size:12px;color:#666">${data.loc} (${data.userWork})</div>
                        <p>${data.desc}</p>
                        <div>${imgs}</div>
                    </div>`;
                    listDiv.innerHTML += card;
                });
            });
        }

        window.logout = () => { if(confirm("Ø®Ø±ÙˆØ¬ØŸ")) auth.signOut().then(()=>location.reload()); };
    </script>
</body>
</html>
