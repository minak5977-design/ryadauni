<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Smart Maintenance V18 (Pro Max)</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* ==================== Design System V18 ==================== */
        :root {
            --primary: #4cc9f0; --secondary: #4361ee;
            --bg-dark: #0f1014; --glass-bg: rgba(30, 30, 35, 0.70);
            --glass-border: rgba(255, 255, 255, 0.08);
            --text-main: #ffffff; --text-sec: #94a3b8;
            --success: #10b981; --danger: #ef4444; --warning: #f59e0b;
            --gradient: linear-gradient(135deg, var(--primary), var(--secondary));
        }

        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; font-family: 'Tajawal', sans-serif; }
        
        body {
            background-color: var(--bg-dark); color: var(--text-main); margin: 0; min-height: 100vh;
            background-image: radial-gradient(circle at 10% 20%, rgba(67, 97, 238, 0.1) 0%, transparent 40%);
            overflow-x: hidden; padding-bottom: 80px;
        }

        .app-container { max-width: 600px; margin: 0 auto; padding: 15px; position: relative; }
        .hidden { display: none !important; }

        /* --- Glass Cards & Inputs --- */
        .glass-card {
            background: var(--glass-bg); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border); border-radius: 20px; padding: 20px; margin-bottom: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3); transition: 0.3s; position: relative; overflow: hidden;
        }
        
        .input-group { margin-bottom: 15px; }
        .input-group label { display: block; font-size: 12px; color: var(--text-sec); margin-bottom: 8px; font-weight: bold; }
        input, select, textarea {
            width: 100%; padding: 14px; background: rgba(0,0,0,0.3); border: 1px solid var(--glass-border);
            border-radius: 12px; color: #fff; font-size: 14px; transition: 0.3s;
        }
        input:focus, select:focus, textarea:focus { border-color: var(--primary); background: rgba(0,0,0,0.5); }

        /* --- Buttons --- */
        .btn {
            width: 100%; padding: 14px; border: none; border-radius: 12px; font-weight: bold; cursor: pointer;
            display: flex; align-items: center; justify-content: center; gap: 8px; transition: 0.2s; font-size: 14px;
        }
        .btn:active { transform: scale(0.97); }
        .btn-primary { background: var(--gradient); color: #fff; box-shadow: 0 4px 15px rgba(67, 97, 238, 0.3); }
        .btn-danger { background: rgba(239, 68, 68, 0.15); color: var(--danger); border: 1px solid var(--danger); }
        .btn-ghost { background: transparent; border: 1px solid var(--glass-border); color: var(--text-sec); }
        .btn-sm { padding: 8px 12px; font-size: 12px; width: auto; }

        /* --- Header & Nav --- */
        .top-header {
            display: flex; justify-content: space-between; align-items: center; padding: 15px 0;
            margin-bottom: 10px;
        }
        .user-mini { display: flex; align-items: center; gap: 10px; cursor: pointer; }
        .avatar-circle { width: 45px; height: 45px; border-radius: 50%; object-fit: cover; border: 2px solid var(--glass-border); }
        
        .bottom-nav {
            position: fixed; bottom: 20px; left: 20px; right: 20px; max-width: 560px; margin: 0 auto;
            background: rgba(20, 20, 25, 0.9); backdrop-filter: blur(20px); border: 1px solid var(--glass-border);
            border-radius: 25px; display: flex; justify-content: space-around; padding: 15px; z-index: 100;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
        }
        .nav-item { color: var(--text-sec); font-size: 20px; cursor: pointer; transition: 0.3s; position: relative; }
        .nav-item.active { color: var(--primary); transform: translateY(-3px); }
        .nav-item.active::after {
            content: ''; position: absolute; bottom: -8px; left: 50%; transform: translateX(-50%);
            width: 5px; height: 5px; background: var(--primary); border-radius: 50%;
        }

        /* --- Request Card Enhancements --- */
        .req-card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; }
        .req-badges { display: flex; flex-direction: column; align-items: flex-end; gap: 5px; }
        
        .badge { padding: 4px 10px; border-radius: 8px; font-size: 10px; font-weight: bold; white-space: nowrap; }
        .badge-high { background: rgba(239, 68, 68, 0.2); color: var(--danger); border: 1px solid var(--danger); }
        .badge-medium { background: rgba(245, 158, 11, 0.2); color: var(--warning); border: 1px solid var(--warning); }
        .badge-low { background: rgba(16, 185, 129, 0.2); color: var(--success); border: 1px solid var(--success); }
        .badge-status { background: rgba(255,255,255,0.1); color: #fff; border: 1px solid var(--glass-border); }

        /* --- Tracking Steps --- */
        .track-container { display: flex; justify-content: space-between; position: relative; margin: 25px 0; }
        .track-container::before {
            content: ''; position: absolute; top: 12px; left: 0; right: 0; height: 2px; background: #333; z-index: 0;
        }
        .step { position: relative; z-index: 1; text-align: center; }
        .step-circle {
            width: 25px; height: 25px; background: #222; border: 2px solid #444; border-radius: 50%;
            margin: 0 auto 5px; display: flex; align-items: center; justify-content: center; font-size: 10px; transition: 0.3s;
        }
        .step.active .step-circle { background: var(--primary); border-color: var(--primary); color: #000; box-shadow: 0 0 10px var(--primary); }
        .step.done .step-circle { background: var(--success); border-color: var(--success); color: #fff; }
        .step-label { font-size: 10px; color: var(--text-sec); }

        /* --- Modals & Overlays --- */
        .modal-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.85); backdrop-filter: blur(5px);
            z-index: 2000; display: flex; align-items: center; justify-content: center; padding: 20px;
            opacity: 0; pointer-events: none; transition: 0.3s;
        }
        .modal-overlay.active { opacity: 1; pointer-events: all; }
        .modal-content {
            width: 100%; max-width: 450px; background: #16171c; border: 1px solid var(--glass-border);
            border-radius: 24px; padding: 25px; max-height: 85vh; overflow-y: auto; transform: translateY(20px); transition: 0.3s;
        }
        .modal-overlay.active .modal-content { transform: translateY(0); }

        /* --- Media Grid --- */
        .media-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(70px, 1fr)); gap: 8px; margin-top: 10px; }
        .media-thumb { width: 100%; height: 70px; object-fit: cover; border-radius: 10px; border: 1px solid var(--glass-border); cursor: pointer; }
    </style>
</head>
<body>

    <div id="loader" style="position:fixed; inset:0; background:#0f1014; z-index:9999; display:flex; flex-direction:column; justify-content:center; align-items:center;">
        <i class="fa-solid fa-bolt fa-bounce fa-3x" style="color:var(--primary); margin-bottom:15px;"></i>
        <span style="font-size:12px; letter-spacing:2px; color:#555;">SMART SYSTEM</span>
    </div>

    <div id="auth-screen" class="app-container hidden" style="height:100vh; display:flex; flex-direction:column; justify-content:center;">
        <div class="glass-card" style="text-align:center; padding: 40px 20px;">
            <div style="width:70px; height:70px; background:var(--gradient); border-radius:20px; margin:0 auto 20px; display:flex; align-items:center; justify-content:center; box-shadow:0 10px 30px rgba(67,97,238,0.4);">
                <i class="fa-solid fa-fingerprint fa-2x" style="color:white;"></i>
            </div>
            <h2 style="margin-bottom:5px;">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h2>
            <p style="color:var(--text-sec); font-size:12px; margin-bottom:30px;">Ø§Ù„Ù…Ù†ØµØ© Ø§Ù„Ø°ÙƒÙŠØ© Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø®Ø¯Ù…Ø§Øª</p>

            <div id="reg-form" class="hidden">
                <div class="input-group">
                    <input type="text" id="reg-name" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„">
                </div>
                <div class="input-group">
                    <select id="reg-role">
                        <option value="employee">Ù…ÙˆØ¸Ù (ØªÙ‚Ø¯ÙŠÙ… Ø¨Ù„Ø§Øº)</option>
                        <option value="supervisor">Ù…Ø´Ø±Ù (Ø¥Ø¯Ø§Ø±Ø©)</option>
                        <option value="technician">ÙÙ†ÙŠ (ØµÙŠØ§Ù†Ø©)</option>
                    </select>
                </div>
            </div>

            <div class="input-group"><input type="email" id="email" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ"></div>
            <div class="input-group"><input type="password" id="pass" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±"></div>

            <button onclick="authAction()" id="auth-btn" class="btn btn-primary">Ø¯Ø®ÙˆÙ„ Ù„Ù„Ù†Ø¸Ø§Ù…</button>
            <p onclick="toggleAuth()" style="margin-top:20px; font-size:12px; color:var(--text-sec); cursor:pointer;">
                <span id="switch-txt">Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ØŸ Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ø¯ÙŠØ¯</span>
            </p>
        </div>
    </div>

    <div id="app-screen" class="hidden">
        <div class="app-container">
            
            <header class="top-header">
                <div class="user-mini" onclick="openMyProfile()">
                    <img id="head-img" src="" class="avatar-circle">
                    <div>
                        <h4 id="head-name" style="margin:0; font-size:14px;">User</h4>
                        <span id="head-role" style="font-size:10px; color:var(--primary);">Role</span>
                    </div>
                </div>
                <div style="display:flex; gap:15px;">
                    <i class="fa-regular fa-bell" style="font-size:20px;"></i>
                    <i class="fa-solid fa-power-off" style="font-size:20px; color:var(--danger);" onclick="document.getElementById('logout-modal').classList.add('active')"></i>
                </div>
            </header>

            <div id="page-home" class="page-sec">
                <div id="add-req-box" class="glass-card hidden">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                        <h4 style="margin:0; color:var(--primary);"><i class="fa-solid fa-plus-circle"></i> Ø¨Ù„Ø§Øº Ø¬Ø¯ÙŠØ¯</h4>
                    </div>
                    
                    <div class="input-group">
                        <label>Ø§Ù„Ù…ÙˆÙ‚Ø¹ (Ø§Ù„ÙƒÙ„ÙŠØ© / Ø§Ù„Ù…Ø¨Ù†Ù‰ / Ø§Ù„Ù‚Ø§Ø¹Ø©)</label>
                        <input type="text" id="req-loc" placeholder="Ù…Ø«Ø§Ù„: Ù‡Ù†Ø¯Ø³Ø© - Ù…Ø¹Ù…Ù„ 3">
                    </div>
                    
                    <div class="input-group">
                        <label>Ù†ÙˆØ¹ Ø§Ù„Ø£Ù‡Ù…ÙŠØ©</label>
                        <div style="display:flex; gap:10px;">
                            <label style="flex:1; cursor:pointer; background:rgba(255,255,255,0.05); padding:10px; border-radius:10px; text-align:center;">
                                <input type="radio" name="prio" value="low" checked> Ø¹Ø§Ø¯ÙŠ
                            </label>
                            <label style="flex:1; cursor:pointer; background:rgba(255,255,255,0.05); padding:10px; border-radius:10px; text-align:center;">
                                <input type="radio" name="prio" value="high"> <span style="color:var(--danger)">Ø¹Ø§Ø¬Ù„</span>
                            </label>
                        </div>
                    </div>

                    <div class="input-group">
                        <label>ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¹Ø·Ù„</label>
                        <textarea id="req-desc" rows="3"></textarea>
                    </div>

                    <div class="input-group">
                        <button onclick="document.getElementById('media-inp').click()" class="btn btn-ghost" style="border-style:dashed;">
                            <i class="fa-solid fa-camera"></i> Ø¥Ø±ÙØ§Ù‚ ØµÙˆØ±/ÙÙŠØ¯ÙŠÙˆ (40 Ø«Ø§Ù†ÙŠØ©)
                        </button>
                        <input type="file" id="media-inp" hidden multiple accept="image/*,video/*" onchange="previewFiles(this)">
                        <div id="upload-preview" class="media-grid"></div>
                    </div>

                    <button onclick="submitReq()" class="btn btn-primary">Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„Ù…Ø´Ø±Ù</button>
                </div>

                <div style="display:flex; gap:10px; margin-bottom:20px;">
                    <button class="btn btn-ghost" onclick="filterFeed('active')" id="tab-active" style="flex:1; background:rgba(255,255,255,0.05);">Ø§Ù„Ø¬Ø§Ø±ÙŠØ©</button>
                    <button class="btn btn-ghost" onclick="filterFeed('history')" id="tab-hist" style="flex:1;">Ø§Ù„Ø£Ø±Ø´ÙŠÙ</button>
                </div>

                <div id="feed-area" style="padding-bottom:100px;"></div>
            </div>

            <div id="page-team" class="page-sec hidden">
                <div class="glass-card">
                    <h3 style="margin-bottom:15px;">ğŸ” Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø²Ù…Ù„Ø§Ø¡</h3>
                    <div style="display:flex; gap:10px;">
                        <input type="text" id="search-inp" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ù€ ID Ø£Ùˆ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„">
                        <button onclick="searchAndAdd()" class="btn btn-primary" style="width:auto;"><i class="fa-solid fa-search"></i></button>
                    </div>
                </div>
                <h4 style="margin:20px 0 10px;">ÙØ±ÙŠÙ‚ Ø§Ù„Ø¹Ù…Ù„</h4>
                <div id="team-list"></div>
            </div>

            <div id="page-trash" class="page-sec hidden">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                    <h3>Ø³Ù„Ø© Ø§Ù„Ù…Ù‡Ù…Ù„Ø§Øª</h3>
                    <button class="btn btn-danger btn-sm" onclick="emptyTrash()">Ø¥ÙØ±Ø§Øº Ø§Ù„ÙƒÙ„</button>
                </div>
                <div id="trash-list"></div>
            </div>

        </div>

        <div class="bottom-nav">
            <div class="nav-item active" onclick="nav('home', this)"><i class="fa-solid fa-list-check"></i></div>
            <div class="nav-item" onclick="nav('team', this)"><i class="fa-solid fa-user-group"></i></div>
            <div class="nav-item" onclick="nav('trash', this)"><i class="fa-solid fa-trash-can"></i></div>
        </div>
    </div>

    <div id="profile-modal" class="modal-overlay">
        <div class="modal-content text-center">
            <div style="text-align:left;"><i class="fa-solid fa-xmark" style="cursor:pointer; font-size:20px;" onclick="closeModal('profile-modal')"></i></div>
            
            <div style="position:relative; width:80px; margin:0 auto 15px;">
                <img id="p-img" src="" class="avatar-circle" style="width:80px; height:80px;">
                <div style="position:absolute; bottom:0; right:0; background:var(--primary); width:25px; height:25px; border-radius:50%; display:flex; align-items:center; justify-content:center; cursor:pointer;" onclick="changePic()"><i class="fa-solid fa-pen" style="font-size:10px; color:#fff;"></i></div>
            </div>
            
            <h3 id="p-name" style="margin:0;">Name</h3>
            <div style="background:rgba(255,255,255,0.1); padding:5px 10px; border-radius:10px; display:inline-block; margin:5px 0; font-size:12px;">
                ID: <span id="p-id" style="font-family:monospace; font-weight:bold; color:var(--primary);">---</span>
            </div>

            <div style="margin-top:20px; text-align:right;">
                <div class="input-group">
                    <label>Ø§Ù„Ø§Ø³Ù…</label>
                    <input type="text" id="edit-name">
                </div>
                <div class="input-group">
                    <label>Ø§Ù„Ù‡Ø§ØªÙ</label>
                    <input type="tel" id="edit-phone">
                </div>
            </div>
            <button onclick="updateProfile()" class="btn btn-primary">Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª</button>
        </div>
    </div>

    <div id="details-modal" class="modal-overlay">
        <div class="modal-content">
            <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
                <h3 style="margin:0;">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨</h3>
                <i class="fa-solid fa-xmark" onclick="closeModal('details-modal')" style="cursor:pointer; font-size:20px;"></i>
            </div>

            <div class="track-container">
                <div class="step" id="step-1">
                    <div class="step-circle"><i class="fa-solid fa-paper-plane"></i></div>
                    <span class="step-label">ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„</span>
                </div>
                <div class="step" id="step-2">
                    <div class="step-circle"><i class="fa-solid fa-user-gear"></i></div>
                    <span class="step-label">Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</span>
                </div>
                <div class="step" id="step-3">
                    <div class="step-circle"><i class="fa-solid fa-check"></i></div>
                    <span class="step-label">Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²</span>
                </div>
            </div>

            <div class="glass-card" style="border:none; background:rgba(255,255,255,0.03);">
                <p style="margin:0 0 10px; color:var(--text-sec); font-size:12px;">ÙˆØµÙ Ø§Ù„Ø¹Ø·Ù„:</p>
                <p id="dt-desc" style="margin:0; line-height:1.6;"></p>
                <div style="margin-top:15px; border-top:1px solid #333; padding-top:10px; display:flex; justify-content:space-between; font-size:12px;">
                    <span id="dt-loc" style="color:var(--primary);"></span>
                    <span id="dt-time" style="color:#777;"></span>
                </div>
            </div>

            <p style="font-size:12px; font-weight:bold; margin-bottom:10px;">Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª:</p>
            <div id="dt-media" class="media-grid"></div>

            <div id="dt-actions" style="margin-top:20px;"></div>
        </div>
    </div>

    <div id="action-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 id="act-head">Ø¥Ø¬Ø±Ø§Ø¡</h3>
            
            <div id="tech-select" class="hidden input-group">
                <label>Ø§Ø®ØªØ± Ø§Ù„ÙÙ†ÙŠ</label>
                <select id="sel-tech"></select>
            </div>

            <div class="input-group">
                <label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª / Ø³Ø¨Ø¨ Ø§Ù„Ø±ÙØ¶</label>
                <textarea id="act-note" rows="3"></textarea>
            </div>

            <div style="display:flex; gap:10px;">
                <button id="act-btn" class="btn btn-primary">ØªØ£ÙƒÙŠØ¯</button>
                <button onclick="closeModal('action-modal')" class="btn btn-ghost">Ø¥Ù„ØºØ§Ø¡</button>
            </div>
        </div>
    </div>

    <div id="logout-modal" class="modal-overlay">
        <div class="modal-content text-center" style="max-width:300px;">
            <h3>ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ</h3>
            <div style="display:flex; gap:10px; margin-top:20px;">
                <button onclick="auth.signOut(); location.reload()" class="btn btn-danger">Ø®Ø±ÙˆØ¬</button>
                <button onclick="closeModal('logout-modal')" class="btn btn-ghost">Ø¥Ù„ØºØ§Ø¡</button>
            </div>
        </div>
    </div>

    <div id="toast" style="position:fixed; top:20px; left:50%; transform:translateX(-50%); background:#333; color:#fff; padding:10px 20px; border-radius:30px; font-size:12px; z-index:5000; display:none; border:1px solid var(--primary);"></div>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

    <script>
        // --- 1. SETUP ---
        const firebaseConfig = {
            apiKey: "AIzaSyABwJfEkkbNB8GurZkyj67R8ksVNEXZ11I", // Demo Key
            authDomain: "ryadanur1-375a8.firebaseapp.com",
            projectId: "ryadanur1-375a8",
            storageBucket: "ryadanur1-375a8.firebasestorage.app",
            messagingSenderId: "858244114090",
            appId: "1:858244114090:web:42cee8e98e3984164392d3"
        };

        try {
            firebase.initializeApp(firebaseConfig);
        } catch(e) { console.error("Firebase Init Error"); }

        const db = firebase.firestore();
        const auth = firebase.auth();
        
        let currentUser, userData;
        let tempMedia = [];
        let tempAction = {};

        // --- 2. AUTH & INIT ---
        auth.onAuthStateChanged(async user => {
            const loader = document.getElementById('loader');
            if (user) {
                currentUser = user;
                const doc = await db.collection('users').doc(user.uid).get();
                if(doc.exists) {
                    userData = doc.data();
                    initApp();
                }
                document.getElementById('auth-screen').classList.add('hidden');
                document.getElementById('app-screen').classList.remove('hidden');
            } else {
                document.getElementById('auth-screen').classList.remove('hidden');
                document.getElementById('app-screen').classList.add('hidden');
            }
            loader.style.display = 'none';
        });

        function toggleAuth() {
            const reg = document.getElementById('reg-form');
            reg.classList.toggle('hidden');
            const isReg = !reg.classList.contains('hidden');
            document.getElementById('auth-btn').innerText = isReg ? 'Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯' : 'Ø¯Ø®ÙˆÙ„ Ù„Ù„Ù†Ø¸Ø§Ù…';
            document.getElementById('switch-txt').innerText = isReg ? 'Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ØŸ ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„' : 'Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ØŸ Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ø¯ÙŠØ¯';
        }

        async function authAction() {
            const email = document.getElementById('email').value;
            const pass = document.getElementById('pass').value;
            const btn = document.getElementById('auth-btn');
            
            if(!email || !pass) return showToast('Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
            btn.innerText = "...";

            try {
                const isReg = !document.getElementById('reg-form').classList.contains('hidden');
                if(isReg) {
                    const name = document.getElementById('reg-name').value;
                    const role = document.getElementById('reg-role').value;
                    // Ø¥Ù†Ø´Ø§Ø¡ shortID Ø¹Ø´ÙˆØ§Ø¦ÙŠ
                    const shortId = Math.floor(100000 + Math.random() * 900000).toString();
                    
                    const cred = await auth.createUserWithEmailAndPassword(email, pass);
                    await db.collection('users').doc(cred.user.uid).set({
                        name, role, email, shortId,
                        photo: 'https://cdn-icons-png.flaticon.com/512/3135/3135715.png',
                        createdAt: new Date()
                    });
                } else {
                    await auth.signInWithEmailAndPassword(email, pass);
                }
            } catch(e) { showToast(e.message); btn.innerText = "Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰"; }
        }

        // --- 3. APP LOGIC ---
        function initApp() {
            // Header Data
            document.getElementById('head-name').innerText = userData.name;
            document.getElementById('head-role').innerText = transRole(userData.role);
            document.getElementById('head-img').src = userData.photo;

            // Permissions
            if(userData.role === 'employee') document.getElementById('add-req-box').classList.remove('hidden');

            loadFeed();
            loadTeam();
        }

        // --- Feed & Requests ---
        function previewFiles(inp) {
            const grid = document.getElementById('upload-preview');
            grid.innerHTML = "";
            tempMedia = [];
            Array.from(inp.files).forEach(f => {
                const url = URL.createObjectURL(f);
                tempMedia.push({file:f, type: f.type.startsWith('video')?'video':'image', url: url}); // Mock logic
                const el = f.type.startsWith('video') ? `<video src="${url}" class="media-thumb"></video>` : `<img src="${url}" class="media-thumb">`;
                grid.innerHTML += el;
            });
        }

        async function submitReq() {
            const desc = document.getElementById('req-desc').value;
            if(!desc) return showToast('Ø§ÙƒØªØ¨ ÙˆØµÙ Ø§Ù„Ø¹Ø·Ù„');
            
            // Mock Upload (Ù„Ù„ØªØ¨Ø³ÙŠØ·ØŒ Ù†Ø³ØªØ®Ø¯Ù… Local URL ÙÙŠ Ø§Ù„Ø¹Ø±Ø¶ ÙˆÙ„ÙƒÙ† ÙÙŠ Ø§Ù„ÙˆØ§Ù‚Ø¹ Ù†Ø­ØªØ§Ø¬ Cloudinary)
            // Ø³Ø£Ù‚ÙˆÙ… Ø¨ØªØ®Ø²ÙŠÙ† Ù†ÙˆØ¹ ÙˆÙ‡Ù…ÙŠ Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„ÙŠØ¹Ù…Ù„ Ø§Ù„Ø¹Ø±Ø¶
            const mediaMeta = tempMedia.map(m => ({type: m.type, url: 'https://placehold.co/600x400?text=Media+File'})); 

            await db.collection('requests').add({
                userId: currentUser.uid,
                userData: { name: userData.name, photo: userData.photo, role: userData.role },
                desc: desc,
                location: document.getElementById('req-loc').value,
                priority: document.querySelector('input[name="prio"]:checked').value,
                status: 'pending', // Steps: pending -> approved -> done
                media: mediaMeta,
                isDeleted: false,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });
            showToast('ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨Ù„Ø§Øº Ø¨Ù†Ø¬Ø§Ø­');
            document.getElementById('req-desc').value = "";
            document.getElementById('upload-preview').innerHTML = "";
        }

        function loadFeed() {
            db.collection('requests').orderBy('timestamp', 'desc').onSnapshot(snap => {
                const area = document.getElementById('feed-area');
                const trash = document.getElementById('trash-list');
                area.innerHTML = ""; trash.innerHTML = "";

                snap.forEach(doc => {
                    const r = { id: doc.id, ...doc.data() };
                    if(r.isDeleted) {
                        trash.innerHTML += createTrashCard(r);
                    } else {
                        // Filter logic based on user role can be added here
                        area.innerHTML += createReqCard(r);
                    }
                });
            });
        }

        function createReqCard(r) {
            const badgeCls = r.priority === 'high' ? 'badge-high' : 'badge-low';
            const statusTxt = transStatus(r.status);
            
            return `
            <div class="glass-card">
                <div class="req-card-header">
                    <div class="user-mini">
                        <img src="${r.userData.photo}" class="avatar-circle" style="width:35px;height:35px;">
                        <div>
                            <b style="font-size:13px;">${r.userData.name}</b>
                            <div style="font-size:10px; color:#aaa;">${r.location}</div>
                        </div>
                    </div>
                    <div class="req-badges">
                        <span class="badge ${badgeCls}">${r.priority === 'high' ? 'Ø¹Ø§Ø¬Ù„ ğŸ”¥' : 'Ø¹Ø§Ø¯ÙŠ'}</span>
                        <span class="badge badge-status">${statusTxt}</span>
                    </div>
                </div>
                <p style="font-size:13px; margin-bottom:10px;">${r.desc}</p>
                <div style="display:flex; gap:10px;">
                    <button class="btn btn-ghost btn-sm" onclick="openDetails('${r.id}')"><i class="fa-solid fa-eye"></i> Ø§Ù„ØªÙØ§ØµÙŠÙ„ ÙˆØ§Ù„ØªØªØ¨Ø¹</button>
                    ${userData.role === 'employee' && r.status==='pending' ? `<button class="btn btn-danger btn-sm" style="width:auto;" onclick="softDelete('${r.id}')"><i class="fa-solid fa-trash"></i></button>` : ''}
                </div>
            </div>`;
        }

        // --- Details & Tracking ---
        async function openDetails(id) {
            const doc = await db.collection('requests').doc(id).get();
            const r = { id: doc.id, ...doc.data() };
            
            // Populate Data
            document.getElementById('dt-desc').innerText = r.desc;
            document.getElementById('dt-loc').innerText = r.location;
            
            // Media
            const mGrid = document.getElementById('dt-media'); mGrid.innerHTML = "";
            if(r.media) r.media.forEach(m => {
                mGrid.innerHTML += `<img src="${m.url}" class="media-thumb" onclick="window.open('${m.url}')">`;
            });

            // Tracking Logic
            document.querySelectorAll('.step').forEach(s => s.className = 'step'); // reset
            if(r.status === 'pending') {
                document.getElementById('step-1').classList.add('active');
            } else if(r.status === 'approved' || r.status === 'suspended') {
                document.getElementById('step-1').classList.add('done');
                document.getElementById('step-2').classList.add('active');
            } else if(r.status === 'done') {
                document.getElementById('step-1').classList.add('done');
                document.getElementById('step-2').classList.add('done');
                document.getElementById('step-3').classList.add('done');
            } else if(r.status === 'rejected') {
                document.getElementById('step-1').classList.add('done');
                document.getElementById('step-2').innerHTML = `<div class="step-circle" style="background:var(--danger); border-color:var(--danger)"><i class="fa-solid fa-xmark"></i></div><span class="step-label">Ù…Ø±ÙÙˆØ¶</span>`;
            }

            // Actions Buttons based on Role
            const actDiv = document.getElementById('dt-actions'); actDiv.innerHTML = "";
            
            if(userData.role === 'supervisor' && r.status === 'pending') {
                actDiv.innerHTML = `
                    <div style="display:flex; gap:10px;">
                        <button class="btn btn-primary" onclick="setupAction('${r.id}', 'approve')">Ù‚Ø¨ÙˆÙ„ ÙˆØªØ¹ÙŠÙŠÙ† ÙÙ†ÙŠ</button>
                        <button class="btn btn-danger" onclick="setupAction('${r.id}', 'reject')">Ø±ÙØ¶</button>
                    </div>`;
            } else if (userData.role === 'technician' && r.status === 'approved') {
                actDiv.innerHTML = `
                    <div style="display:flex; gap:10px;">
                        <button class="btn btn-primary" onclick="updateReqStatus('${r.id}', 'done')">ØªÙ… Ø§Ù„Ø¥ØµÙ„Ø§Ø­ âœ…</button>
                        <button class="btn btn-ghost" onclick="setupAction('${r.id}', 'suspend')">ØªØ¹Ù„ÙŠÙ‚ Ø§Ù„Ø¹Ù…Ù„ âœ‹</button>
                    </div>`;
            }

            document.getElementById('details-modal').classList.add('active');
        }

        // --- Action Logic (Modal) ---
        async function setupAction(id, type) {
            tempAction = { id, type };
            document.getElementById('details-modal').classList.remove('active'); // Close details
            document.getElementById('action-modal').classList.add('active'); // Open action
            
            const techSel = document.getElementById('tech-select');
            const title = document.getElementById('act-head');
            
            if(type === 'approve') {
                title.innerText = "ØªØ¹ÙŠÙŠÙ† ÙÙ†ÙŠ Ù„Ù„ØµÙŠØ§Ù†Ø©";
                techSel.classList.remove('hidden');
                // Load Technicians
                const snap = await db.collection('users').where('role', '==', 'technician').get();
                const sel = document.getElementById('sel-tech'); sel.innerHTML = "";
                snap.forEach(d => {
                    sel.innerHTML += `<option value="${d.id}">${d.data().name}</option>`;
                });
            } else {
                title.innerText = type === 'reject' ? "Ø³Ø¨Ø¨ Ø§Ù„Ø±ÙØ¶" : "Ø³Ø¨Ø¨ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚";
                techSel.classList.add('hidden');
            }

            document.getElementById('act-btn').onclick = () => doAction();
        }

        async function doAction() {
            const { id, type } = tempAction;
            const note = document.getElementById('act-note').value;
            
            let data = { note: note };
            if(type === 'approve') {
                data.status = 'approved';
                const sel = document.getElementById('sel-tech');
                data.techId = sel.value;
                data.techName = sel.options[sel.selectedIndex].text;
            } else if (type === 'reject') data.status = 'rejected';
            else if (type === 'suspend') data.status = 'suspended';

            await db.collection('requests').doc(id).update(data);
            closeModal('action-modal');
            showToast('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©');
        }

        async function updateReqStatus(id, st) {
            await db.collection('requests').doc(id).update({status: st});
            closeModal('details-modal');
            showToast('ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«');
        }

        // --- Profile & ID ---
        function openMyProfile() {
            document.getElementById('profile-modal').classList.add('active');
            document.getElementById('p-img').src = userData.photo;
            document.getElementById('p-name').innerText = userData.name;
            document.getElementById('p-id').innerText = userData.shortId || '---';
            document.getElementById('edit-name').value = userData.name;
            document.getElementById('edit-phone').value = userData.phone || '';
        }

        async function updateProfile() {
            const newName = document.getElementById('edit-name').value;
            const newPhone = document.getElementById('edit-phone').value;
            await db.collection('users').doc(currentUser.uid).update({
                name: newName, phone: newPhone
            });
            userData.name = newName; userData.phone = newPhone;
            initApp(); // refresh UI
            closeModal('profile-modal');
            showToast('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ');
        }

        // --- Friends System (Fixed) ---
        async function searchAndAdd() {
            const q = document.getElementById('search-inp').value;
            if(!q) return;
            
            // Search by shortId OR email
            let snap = await db.collection('users').where('shortId', '==', q).get();
            if(snap.empty) snap = await db.collection('users').where('email', '==', q).get();

            if(snap.empty) return showToast('Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
            
            const target = snap.docs[0];
            if(target.id === currentUser.uid) return showToast('Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ù†ÙØ³Ùƒ');

            await db.collection('friends').add({
                from: currentUser.uid, to: target.id, 
                targetName: target.data().name, targetRole: target.data().role, targetPhoto: target.data().photo
            });
            showToast('ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø²Ù…ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­');
            loadTeam();
        }

        function loadTeam() {
            db.collection('friends').where('from', '==', currentUser.uid).onSnapshot(snap => {
                const list = document.getElementById('team-list'); list.innerHTML = "";
                snap.forEach(doc => {
                    const f = doc.data();
                    list.innerHTML += `
                    <div class="glass-card" style="padding:10px; display:flex; align-items:center; gap:10px;">
                        <img src="${f.targetPhoto}" class="avatar-circle">
                        <div>
                            <b>${f.targetName}</b><br>
                            <span style="font-size:10px; color:#aaa">${transRole(f.targetRole)}</span>
                        </div>
                    </div>`;
                });
            });
        }

        // --- Trash & Helpers ---
        async function softDelete(id) { if(confirm('Ù†Ù‚Ù„ Ù„Ù„Ù…Ù‡Ù…Ù„Ø§ØªØŸ')) await db.collection('requests').doc(id).update({isDeleted:true}); }
        function createTrashCard(r) { return `<div class="glass-card" style="opacity:0.6"><p>${r.desc}</p><button class="btn btn-primary btn-sm" onclick="db.collection('requests').doc('${r.id}').update({isDeleted:false})">Ø§Ø³ØªØ¹Ø§Ø¯Ø©</button></div>`; }
        async function emptyTrash() { showToast('ØªÙ… Ø¥ÙØ±Ø§Øº Ø§Ù„Ø³Ù„Ø© (Mock)'); } // Needs backend function to really delete

        function nav(page, el) {
            document.querySelectorAll('.page-sec').forEach(p=>p.classList.add('hidden'));
            document.getElementById('page-'+page).classList.remove('hidden');
            document.querySelectorAll('.nav-item').forEach(i=>i.classList.remove('active'));
            el.classList.add('active');
        }
        function closeModal(id) { document.getElementById(id).classList.remove('active'); }
        function showToast(msg) { const t = document.getElementById('toast'); t.innerText=msg; t.style.display='block'; setTimeout(()=>t.style.display='none', 3000); }
        function transRole(r) { return r==='employee'?'Ù…ÙˆØ¸Ù':r==='supervisor'?'Ù…Ø´Ø±Ù':'ÙÙ†ÙŠ'; }
        function transStatus(s) { const m={'pending':'Ø§Ù†ØªØ¸Ø§Ø±','approved':'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¹Ù…Ù„','done':'Ù…ÙƒØªÙ…Ù„','rejected':'Ù…Ø±ÙÙˆØ¶','suspended':'Ù…Ø¹Ù„Ù‚'}; return m[s]||s; }

    </script>
</body>
</html>
