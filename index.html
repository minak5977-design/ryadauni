<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Smart Maintenance Pro</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* =========================================
           1. Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª ÙˆØ§Ù„ØªØµÙ…ÙŠÙ… Ø§Ù„Ø¹Ø§Ù… (THEME)
        ========================================= */
        :root {
            --primary: #4361ee;
            --secondary: #3f37c9;
            --success: #06d6a0;
            --warning: #f72585;
            --dark-bg: #0f172a;
            --glass-bg: rgba(30, 41, 59, 0.7);
            --glass-border: rgba(255, 255, 255, 0.08);
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
        }

        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: 'Cairo', sans-serif;
            background-color: var(--dark-bg);
            background-image: radial-gradient(at 0% 0%, hsla(253,16%,7%,1) 0, transparent 50%), 
                              radial-gradient(at 50% 0%, hsla(225,39%,30%,1) 0, transparent 50%), 
                              radial-gradient(at 100% 0%, hsla(339,49%,30%,1) 0, transparent 50%);
            color: var(--text-main);
            margin: 0;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Ø­Ø§ÙˆÙŠØ© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ */
        .app-wrapper {
            max-width: 500px;
            margin: 0 auto;
            min-height: 100vh;
            position: relative;
            background: rgba(0,0,0,0.2);
            box-shadow: 0 0 50px rgba(0,0,0,0.5);
        }

        /* =========================================
           2. Ù…ÙƒÙˆÙ†Ø§Øª Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© (UI COMPONENTS)
        ========================================= */
        
        /* Ø§Ù„ÙƒØ±ÙˆØª Ø§Ù„Ø²Ø¬Ø§Ø¬ÙŠØ© */
        .glass-card {
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 20px;
            margin: 15px;
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
            animation: slideUp 0.4s ease-out;
        }

        /* Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª */
        input, textarea, select {
            width: 100%;
            padding: 15px;
            margin-bottom: 15px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            color: white;
            font-family: 'Cairo', sans-serif;
            font-size: 16px;
            transition: 0.3s;
        }
        input:focus, textarea:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(67, 97, 238, 0.2);
        }

        /* Ø§Ù„Ø£Ø²Ø±Ø§Ø± */
        .btn-main {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border: none;
            border-radius: 12px;
            color: white;
            font-weight: 700;
            font-size: 16px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(67, 97, 238, 0.4);
            transition: transform 0.2s;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
        }
        .btn-main:active { transform: scale(0.98); }
        .btn-main:disabled { opacity: 0.7; cursor: wait; }

        /* Ù…Ù†Ø·Ù‚Ø© Ø±ÙØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª */
        .upload-area {
            border: 2px dashed var(--glass-border);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            margin-bottom: 15px;
            cursor: pointer;
            transition: 0.3s;
        }
        .upload-area:hover { border-color: var(--primary); background: rgba(67, 97, 238, 0.1); }
        .upload-icon { font-size: 24px; color: var(--text-muted); margin-bottom: 10px; }

        /* Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø·Ù„Ø¨ */
        .req-item {
            background: rgba(255,255,255,0.03);
            border-radius: 16px;
            padding: 15px;
            margin-bottom: 12px;
            border-right: 4px solid transparent;
            transition: 0.3s;
        }
        .req-item.status-pending { border-color: #f72585; }
        .req-item.status-approved { border-color: #4361ee; }
        .req-item.status-done { border-color: #06d6a0; }

        .badge {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }
        .badge-pending { background: rgba(247, 37, 133, 0.2); color: #f72585; }
        .badge-approved { background: rgba(67, 97, 238, 0.2); color: #4361ee; }
        .badge-done { background: rgba(6, 214, 160, 0.2); color: #06d6a0; }

        /* Ø§Ù„Ù‡ÙŠØ¯Ø± */
        .top-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            background: rgba(15, 23, 42, 0.8);
            backdrop-filter: blur(10px);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        /* Ø§Ù„ØªÙˆØ³Øª (Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª) */
        #toast-container {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
        }
        .toast {
            background: #333;
            color: white;
            padding: 12px 24px;
            border-radius: 50px;
            margin-top: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
            animation: fadeIn 0.3s, fadeOut 0.3s 2.7s;
            display: flex;
            align-items: center;
            gap: 10px;
            min-width: 250px;
            justify-content: center;
        }
        .toast.success { background: var(--success); color: #000; }
        .toast.error { background: var(--warning); }

        /* Ø§Ù„Ø£Ù†ÙŠÙ…ÙŠØ´Ù† */
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }

        .hidden { display: none !important; }
        
        /* Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ */
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        .stat-box { background: rgba(255,255,255,0.05); padding: 15px; border-radius: 12px; text-align: center; }
        .stat-num { font-size: 24px; font-weight: bold; display: block; }
        .stat-label { font-size: 12px; color: var(--text-muted); }

    </style>
</head>
<body>

<div class="app-wrapper">
    
    <div id="loader" style="position:fixed; inset:0; background:var(--dark-bg); z-index:999; display:flex; justify-content:center; align-items:center;">
        <i class="fa-solid fa-circle-notch fa-spin fa-3x" style="color:var(--primary)"></i>
    </div>

    <div id="auth-screen" class="hidden">
        <div style="height: 100vh; display: flex; flex-direction: column; justify-content: center; padding: 20px;">
            <div style="text-align: center; margin-bottom: 40px;">
                <i class="fa-solid fa-screwdriver-wrench" style="font-size: 50px; color: var(--primary); margin-bottom: 20px;"></i>
                <h1>Ù†Ø¸Ø§Ù… Ø§Ù„ØµÙŠØ§Ù†Ø© Ø§Ù„Ø°ÙƒÙŠ</h1>
                <p style="color: var(--text-muted);">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù‡Ø§Ù… Ø¨ÙƒÙØ§Ø¡Ø© ÙˆØ³Ø±Ø¹Ø©</p>
            </div>

            <div class="glass-card">
                <h3 id="auth-title" style="margin-top: 0; text-align: center;">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h3>
                
                <div id="role-select-container" class="hidden">
                    <label style="font-size: 14px; margin-bottom: 5px; display: block;">Ø§Ø®ØªØ± Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©:</label>
                    <select id="user-role">
                        <option value="employee">ğŸ‘¤ Ù…ÙˆØ¸Ù (Ù…Ù‚Ø¯Ù… Ø·Ù„Ø¨)</option>
                        <option value="supervisor">ğŸ‘” Ù…Ø´Ø±Ù (Ø¥Ø¯Ø§Ø±Ø©)</option>
                        <option value="technician">ğŸ”§ ÙÙ†ÙŠ (ØµÙŠØ§Ù†Ø©)</option>
                    </select>
                </div>

                <div style="position: relative;">
                    <i class="fa-solid fa-envelope" style="position: absolute; top: 18px; left: 15px; color: #aaa;"></i>
                    <input type="email" id="email" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ" style="padding-left: 40px;">
                </div>
                
                <div style="position: relative;">
                    <i class="fa-solid fa-lock" style="position: absolute; top: 18px; left: 15px; color: #aaa;"></i>
                    <input type="password" id="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" style="padding-left: 40px;">
                </div>

                <button onclick="handleAuth()" id="auth-btn" class="btn-main">
                     Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù†Ø¸Ø§Ù…
                </button>
                
                <p class="switch-auth" onclick="toggleAuthMode()" style="text-align: center; margin-top: 15px; cursor: pointer; color: var(--primary);">
                    Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ØŸ Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯
                </p>
            </div>
        </div>
    </div>

    <div id="app-container" class="hidden">
        <div class="top-nav">
            <div>
                <h3 style="margin: 0; font-size: 18px;">ğŸ‘‹ Ù…Ø±Ø­Ø¨Ø§Ù‹ØŒ <span id="user-name-display"></span></h3>
                <small id="user-role-display" style="color: var(--text-muted); font-size: 12px;"></small>
            </div>
            <button onclick="logout()" style="background: rgba(255,255,255,0.1); border:none; color:white; width: 40px; height: 40px; border-radius: 50%;">
                <i class="fa-solid fa-right-from-bracket"></i>
            </button>
        </div>

        <div style="padding: 10px;">
            
            <div id="employee-view" class="hidden">
                <div class="glass-card">
                    <h3 style="margin-top: 0;"><i class="fa-solid fa-plus-circle"></i> Ø·Ù„Ø¨ ØµÙŠØ§Ù†Ø© Ø¬Ø¯ÙŠØ¯</h3>
                    <input type="text" id="req-title" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¹Ø·Ù„ (Ù…Ø«Ø§Ù„: ØªÙƒÙŠÙŠÙ ØºØ±ÙØ© Ø§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹Ø§Øª)">
                    <textarea id="req-desc" rows="3" placeholder="ÙˆØµÙ Ø§Ù„Ù…Ø´ÙƒÙ„Ø© Ø¨Ø§Ù„ØªÙØµÙŠÙ„..."></textarea>
                    
                    <div class="upload-area" onclick="document.getElementById('req-media').click()">
                        <i class="fa-solid fa-cloud-arrow-up upload-icon"></i>
                        <p style="margin: 0; font-size: 14px;">Ø§Ø¶ØºØ· Ù‡Ù†Ø§ Ù„Ø±ÙØ¹ ØµÙˆØ±Ø© Ø£Ùˆ ÙÙŠØ¯ÙŠÙˆ</p>
                        <input type="file" id="req-media" hidden onchange="previewFile()">
                        <p id="file-name" style="margin: 5px 0 0; color: var(--success); font-size: 12px;"></p>
                    </div>

                    <button onclick="submitRequest()" class="btn-main">
                        <i class="fa-regular fa-paper-plane"></i> Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨
                    </button>
                </div>
                
                <h4 style="margin: 20px 15px 10px;">ğŸ“¦ Ø³Ø¬Ù„ Ø·Ù„Ø¨Ø§ØªÙŠ</h4>
                <div id="employee-list"></div>
            </div>

            <div id="supervisor-view" class="hidden">
                <div class="stats-grid">
                    <div class="stat-box">
                        <span class="stat-num" style="color: var(--warning);" id="sup-count-pending">0</span>
                        <span class="stat-label">Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±</span>
                    </div>
                    <div class="stat-box">
                        <span class="stat-num" style="color: var(--success);" id="sup-count-done">0</span>
                        <span class="stat-label">ØªÙ… Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²</span>
                    </div>
                </div>
                <h4 style="margin: 10px 15px;">ğŸ“¥ Ø·Ù„Ø¨Ø§Øª ÙˆØ§Ø±Ø¯Ø© Ù„Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</h4>
                <div id="supervisor-list"></div>
            </div>

            <div id="technician-view" class="hidden">
                <div class="glass-card" style="background: linear-gradient(45deg, #1e293b, #0f172a);">
                    <h3 style="margin:0; text-align: center; color: var(--primary);">ğŸ”§ Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</h3>
                </div>
                <h4 style="margin: 10px 15px;">ğŸ“‹ Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ù…Ø³Ù†Ø¯Ø© Ø¥Ù„ÙŠÙƒ</h4>
                <div id="technician-list"></div>
            </div>

        </div>
    </div>

    <div id="toast-container"></div>

</div>

<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

<script>
    // ==========================================
    // 1. Ø§Ù„ØªÙƒÙˆÙŠÙ† (CONFIGURATION)
    // ==========================================
    const firebaseConfig = {
        apiKey: "AIzaSyABwJfEkkbNB8GurZkyj67R8ksVNEXZ11I",
        authDomain: "ryadanur1-375a8.firebaseapp.com",
        projectId: "ryadanur1-375a8",
        storageBucket: "ryadanur1-375a8.firebasestorage.app",
        messagingSenderId: "858244114090",
        appId: "1:858244114090:web:42cee8e98e3984164392d3"
    };

    const CLOUDINARY_CLOUD_NAME = "djzfruh22"; 
    const CLOUDINARY_PRESET = "udyvggup"; 

    // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    let currentUser = null;
    let isLoginMode = true;

    // ==========================================
    // 2. Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† (AUTH)
    // ==========================================
    
    // Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø­Ø§Ù„Ø©
    auth.onAuthStateChanged(user => {
        document.getElementById('loader').classList.add('hidden'); // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„ØªØ­Ù…ÙŠÙ„
        if (user) {
            currentUser = user;
            loadUserApp(user.uid);
        } else {
            showAuthScreen();
        }
    });

    async function loadUserApp(uid) {
        try {
            const doc = await db.collection('users').doc(uid).get();
            if (doc.exists) {
                const role = doc.data().role;
                setupUI(role, doc.data().email);
            }
        } catch (error) {
            showToast("Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª", "error");
        }
    }

    function toggleAuthMode() {
        isLoginMode = !isLoginMode;
        const title = document.getElementById('auth-title');
        const btn = document.getElementById('auth-btn');
        const switchText = document.querySelector('.switch-auth');
        const roleContainer = document.getElementById('role-select-container');

        if (isLoginMode) {
            title.innerText = "ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„";
            btn.innerText = "Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù†Ø¸Ø§Ù…";
            switchText.innerText = "Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ØŸ Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯";
            roleContainer.classList.add('hidden');
        } else {
            title.innerText = "Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯";
            btn.innerText = "ØªØ³Ø¬ÙŠÙ„ Ø­Ø³Ø§Ø¨";
            switchText.innerText = "Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ Ø¨Ø§Ù„ÙØ¹Ù„ØŸ Ø¯Ø®ÙˆÙ„";
            roleContainer.classList.remove('hidden');
        }
    }

    async function handleAuth() {
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        const role = document.getElementById('user-role').value;
        const btn = document.getElementById('auth-btn');

        if(!email || !password) return showToast("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„", "error");
        
        btn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¹Ù…Ù„...';
        btn.disabled = true;

        try {
            if (isLoginMode) {
                await auth.signInWithEmailAndPassword(email, password);
                showToast("ØªÙ… Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­", "success");
            } else {
                const cred = await auth.createUserWithEmailAndPassword(email, password);
                await db.collection('users').doc(cred.user.uid).set({
                    email: email, role: role, createdAt: new Date()
                });
                showToast("ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨", "success");
            }
        } catch (error) {
            showToast(error.message, "error");
            btn.innerHTML = isLoginMode ? 'Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù†Ø¸Ø§Ù…' : 'ØªØ³Ø¬ÙŠÙ„ Ø­Ø³Ø§Ø¨';
            btn.disabled = false;
        }
    }

    function logout() {
        auth.signOut();
        window.location.reload();
    }

    // ==========================================
    // 3. ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆØ§Ù„Ù…Ù†Ø·Ù‚ (UI LOGIC)
    // ==========================================

    function showAuthScreen() {
        document.getElementById('auth-screen').classList.remove('hidden');
        document.getElementById('app-container').classList.add('hidden');
    }

    function setupUI(role, email) {
        document.getElementById('auth-screen').classList.add('hidden');
        document.getElementById('app-container').classList.remove('hidden');
        
        // Ø¹Ø±Ø¶ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆØ¯ÙˆØ±Ù‡
        document.getElementById('user-name-display').innerText = email.split('@')[0];
        const roleNames = {'employee': 'Ù…ÙˆØ¸Ù', 'supervisor': 'Ù…Ø´Ø±Ù', 'technician': 'ÙÙ†ÙŠ ØµÙŠØ§Ù†Ø©'};
        document.getElementById('user-role-display').innerText = roleNames[role];

        // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø© Ù„Ù„Ø¯ÙˆØ±
        if (role === 'employee') {
            document.getElementById('employee-view').classList.remove('hidden');
            subscribeToData('employee');
        } else if (role === 'supervisor') {
            document.getElementById('supervisor-view').classList.remove('hidden');
            subscribeToData('supervisor');
        } else if (role === 'technician') {
            document.getElementById('technician-view').classList.remove('hidden');
            subscribeToData('technician');
        }
    }

    function previewFile() {
        const file = document.getElementById('req-media').files[0];
        if (file) document.getElementById('file-name').innerText = "ØªÙ… Ø§Ø®ØªÙŠØ§Ø±: " + file.name;
    }

    // ==========================================
    // 4. Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª (ACTIONS)
    // ==========================================

    async function uploadToCloudinary(file) {
        const formData = new FormData();
        formData.append('file', file);
        formData.append('upload_preset', CLOUDINARY_PRESET);
        
        try {
            const res = await fetch(`https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/upload`, {
                method: 'POST', body: formData
            });
            const data = await res.json();
            return data.secure_url;
        } catch (e) {
            throw new Error("ÙØ´Ù„ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©");
        }
    }

    async function submitRequest() {
        const title = document.getElementById('req-title').value;
        const desc = document.getElementById('req-desc').value;
        const fileInput = document.getElementById('req-media');
        
        if (!title) return showToast("ÙŠØ¬Ø¨ ÙƒØªØ§Ø¨Ø© Ø¹Ù†ÙˆØ§Ù† Ù„Ù„Ø¹Ø·Ù„", "error");

        showToast("Ø¬Ø§Ø±ÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨...", "info");
        
        let imageUrl = "";
        if (fileInput.files[0]) {
            try {
                imageUrl = await uploadToCloudinary(fileInput.files[0]);
            } catch (e) {
                return showToast("ÙØ´Ù„ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰", "error");
            }
        }

        try {
            await db.collection('requests').add({
                userId: currentUser.uid,
                email: currentUser.email,
                title: title, desc: desc, imageUrl: imageUrl,
                status: 'pending',
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            showToast("ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨Ù„Ø§Øº Ø¨Ù†Ø¬Ø§Ø­! ğŸš€", "success");
            
            // ØªØµÙÙŠØ± Ø§Ù„Ø­Ù‚ÙˆÙ„
            document.getElementById('req-title').value = "";
            document.getElementById('req-desc').value = "";
            fileInput.value = "";
            document.getElementById('file-name').innerText = "";
        } catch (e) {
            showToast(e.message, "error");
        }
    }

    async function changeStatus(id, newStatus) {
        try {
            await db.collection('requests').doc(id).update({ status: newStatus });
            showToast("ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©", "success");
        } catch (e) {
            showToast("Ø­Ø¯Ø« Ø®Ø·Ø£", "error");
        }
    }

    // ==========================================
    // 5. Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ø§Ù„Ù…Ø¨Ø§Ø´Ø± (REALTIME LISTENER)
    // ==========================================

    function subscribeToData(role) {
        let q = db.collection('requests');
        let targetId = '';

        if (role === 'employee') {
            q = q.where('userId', '==', currentUser.uid);
            targetId = 'employee-list';
        } else if (role === 'supervisor') {
            q = q.where('status', '==', 'pending');
            targetId = 'supervisor-list';
        } else if (role === 'technician') {
            q = q.where('status', '==', 'approved');
            targetId = 'technician-list';
        }

        q.onSnapshot(snapshot => {
            const container = document.getElementById(targetId);
            container.innerHTML = "";
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø¯Ø§Ø¯Ø§Øª Ù„Ù„Ù…Ø´Ø±Ù
            if (role === 'supervisor') updateStats(snapshot.size);

            if (snapshot.empty) {
                container.innerHTML = `
                    <div style="text-align:center; padding:40px; color:var(--text-muted)">
                        <i class="fa-regular fa-folder-open fa-2x"></i>
                        <p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹</p>
                    </div>`;
                return;
            }

            snapshot.forEach(doc => {
                renderCard(container, doc.id, doc.data(), role);
            });
        });
    }

    function renderCard(container, id, data, role) {
        const badges = {
            'pending': '<span class="badge badge-pending">Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±</span>',
            'approved': '<span class="badge badge-approved">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙ†ÙÙŠØ°</span>',
            'done': '<span class="badge badge-done">ØªÙ… Ø§Ù„Ø¥ØµÙ„Ø§Ø­</span>'
        };

        let actions = '';
        if (role === 'supervisor') {
            actions = `
                <div style="display:flex; gap:10px; margin-top:15px;">
                    <button onclick="changeStatus('${id}', 'approved')" class="btn-main" style="background:var(--success); font-size:14px; padding:10px;">
                        <i class="fa-solid fa-check"></i> Ù‚Ø¨ÙˆÙ„
                    </button>
                    <button onclick="changeStatus('${id}', 'rejected')" class="btn-main" style="background:var(--warning); font-size:14px; padding:10px;">
                        <i class="fa-solid fa-xmark"></i> Ø±ÙØ¶
                    </button>
                </div>
            `;
        } else if (role === 'technician') {
            actions = `
                <button onclick="changeStatus('${id}', 'done')" class="btn-main" style="margin-top:15px; background:var(--success);">
                    <i class="fa-solid fa-check-double"></i> Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ù…Ù‡Ù…Ø©
                </button>
            `;
        }

        let mediaBtn = data.imageUrl ? 
            `<a href="${data.imageUrl}" target="_blank" style="display:inline-block; margin-top:10px; color:var(--primary); text-decoration:none;">
                <i class="fa-solid fa-image"></i> Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø±ÙÙ‚
             </a>` : '';

        const html = `
            <div class="req-item status-${data.status}">
                <div style="display:flex; justify-content:space-between; align-items:start;">
                    <h4 style="margin:0;">${data.title}</h4>
                    ${badges[data.status] || ''}
                </div>
                <p style="color:var(--text-muted); font-size:14px; margin:5px 0;">${data.desc}</p>
                <small style="color:#666;"><i class="fa-regular fa-user"></i> ${data.email}</small>
                <br>
                ${mediaBtn}
                ${actions}
            </div>
        `;
        container.insertAdjacentHTML('beforeend', html);
    }

    function updateStats(pendingCount) {
        // ØªØ­Ø¯ÙŠØ« Ø¨Ø³ÙŠØ· Ù„Ù„Ø¹Ø¯Ø§Ø¯Ø§Øª (Ù„Ù„Ø¹Ø±Ø¶ ÙÙ‚Ø·)
        document.getElementById('sup-count-pending').innerText = pendingCount;
    }

    // Ø¯Ø§Ù„Ø© Ø¹Ø±Ø¶ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª (Toast)
    function showToast(msg, type = 'info') {
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        
        let icon = type === 'success' ? '<i class="fa-solid fa-circle-check"></i>' : 
                   type === 'error' ? '<i class="fa-solid fa-circle-exclamation"></i>' : 
                   '<i class="fa-solid fa-circle-info"></i>';

        toast.innerHTML = `${icon} <span>${msg}</span>`;
        container.appendChild(toast);
        
        setTimeout(() => toast.remove(), 3000);
    }

</script>
</body>
</html>
