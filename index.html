<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Smart Maintenance</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --primary: #2563eb; /* Ø£Ø²Ø±Ù‚ Ø¹ØµØ±ÙŠ */
            --primary-dark: #1e40af;
            --bg-color: #f3f4f6;
            --surface: #ffffff;
            --text-main: #1f2937;
            --text-light: #6b7280;
        }

        * { box-sizing: border-box; font-family: 'Cairo', sans-serif; -webkit-tap-highlight-color: transparent; }
        
        body {
            margin: 0;
            background: url('https://a.top4top.io/p_36115ao3o1.jpg') no-repeat center center fixed;
            background-size: cover;
            display: flex; justify-content: center; align-items: center; min-height: 100vh; padding: 15px;
        }
        
        /* Ø·Ø¨Ù‚Ø© ØªØ¸Ù„ÙŠÙ„ Ø³ÙˆØ¯Ø§Ø¡ Ù†Ø§Ø¹Ù…Ø© ÙÙˆÙ‚ Ø§Ù„Ø®Ù„ÙÙŠØ© */
        body::before {
            content: ''; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(17, 24, 39, 0.6); backdrop-filter: blur(8px); z-index: -1;
        }

        /* Ø§Ù„ÙƒØ§Ø±Øª Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ (Main Card) */
        .app-card {
            width: 100%; max-width: 420px;
            background: var(--surface);
            border-radius: 24px;
            padding: 30px 25px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
            animation: slideUp 0.6s cubic-bezier(0.2, 0.8, 0.2, 1);
            position: relative; overflow: hidden;
        }
        @keyframes slideUp { from { transform: translateY(30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        .hidden { display: none !important; }

        /* Ø§Ù„ØªØ±ÙˆÙŠØ³Ø© */
        .brand-header { text-align: center; margin-bottom: 25px; }
        .brand-header i { font-size: 40px; color: var(--primary); background: #eff6ff; padding: 15px; border-radius: 20px; margin-bottom: 10px; }
        .brand-header h1 { margin: 0; font-size: 22px; font-weight: 800; color: var(--text-main); }
        .brand-header p { margin: 5px 0 0; font-size: 13px; color: var(--text-light); }

        /* Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª Ø§Ù„Ø¹Ù„ÙˆÙŠØ© (Tabs) */
        .tabs-container {
            display: flex; background: #f3f4f6; padding: 5px; border-radius: 16px; margin-bottom: 25px; position: relative;
        }
        .tab-btn {
            flex: 1; text-align: center; padding: 12px; border-radius: 12px;
            font-size: 14px; font-weight: 700; color: var(--text-light); cursor: pointer;
            transition: 0.3s; z-index: 2;
        }
        .tab-btn.active { background: #fff; color: var(--primary); box-shadow: 0 4px 10px rgba(0,0,0,0.05); }

        /* Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ (Inputs) */
        .input-group { margin-bottom: 18px; position: relative; }
        .input-group label { display: block; font-size: 13px; font-weight: 700; margin-bottom: 8px; color: #374151; }
        
        .modern-input {
            width: 100%; padding: 16px 16px 16px 45px; /* Ù…Ø³Ø§ÙØ© Ù„Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© */
            border: 2px solid #e5e7eb; border-radius: 14px;
            font-size: 15px; transition: 0.3s; outline: none; background: #f9fafb;
        }
        .modern-input:focus { border-color: var(--primary); background: #fff; }
        .input-icon { position: absolute; right: 15px; top: 42px; color: #9ca3af; font-size: 18px; }

        /* Ø§Ù„Ø£Ø²Ø±Ø§Ø± (Buttons) */
        .btn-primary {
            width: 100%; padding: 16px; border: none; border-radius: 14px;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white; font-size: 16px; font-weight: 700; cursor: pointer;
            box-shadow: 0 10px 20px rgba(37, 99, 235, 0.2);
            transition: 0.3s; margin-top: 10px;
        }
        .btn-primary:active { transform: scale(0.98); }
        .btn-primary:disabled { background: #cbd5e1; box-shadow: none; cursor: not-allowed; }

        /* Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø£Ø¯ÙˆØ§Ø± */
        .roles-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        .role-option {
            background: #fff; border: 2px solid #e5e7eb; border-radius: 14px; padding: 15px 5px;
            text-align: center; cursor: pointer; transition: 0.2s;
        }
        .role-option i { font-size: 22px; color: #6b7280; margin-bottom: 8px; display: block; }
        .role-option span { font-size: 12px; font-weight: 700; color: #374151; }
        
        .role-option.selected { border-color: var(--primary); background: #eff6ff; }
        .role-option.selected i, .role-option.selected span { color: var(--primary); }

        /* Ø´Ø§Ø´Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ */
        .user-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; }
        .user-info { display: flex; align-items: center; gap: 12px; }
        .user-avatar { width: 48px; height: 48px; border-radius: 50%; object-fit: cover; border: 2px solid #e5e7eb; }
        .logout-btn { background: #fee2e2; color: #ef4444; border: none; padding: 8px 12px; border-radius: 10px; font-weight: 700; font-size: 12px; cursor: pointer; }

        /* Ø§Ù„Ø±ÙØ¹ ÙˆØ§Ù„Ù…Ø¹Ø±Ø¶ */
        .upload-zone {
            border: 2px dashed #d1d5db; border-radius: 16px; padding: 25px; text-align: center;
            background: #f9fafb; cursor: pointer; transition: 0.3s; margin-bottom: 15px;
        }
        .upload-zone:active { border-color: var(--primary); background: #eff6ff; }
        .gallery-grid { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 10px; margin-bottom: 15px; }
        .gallery-grid img { width: 70px; height: 70px; border-radius: 12px; object-fit: cover; border: 1px solid #e5e7eb; }

        /* Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø­Ø§Ù„Ø© */
        .status-msg { text-align: center; font-size: 13px; margin-top: 15px; font-weight: 600; min-height: 20px; }

    </style>
</head>
<body>

    <div id="authScreen" class="app-card">
        <div class="brand-header">
            <i class="fas fa-wrench"></i>
            <h1>Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„ØµÙŠØ§Ù†Ø©</h1>
            <p>Ù…Ù†ØµØ© Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¨Ù„Ø§ØºØ§Øª Ø§Ù„Ø°ÙƒÙŠØ©</p>
        </div>

        <div class="tabs-container">
            <div class="tab-btn active" onclick="setTab('login')">ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„</div>
            <div class="tab-btn" onclick="setTab('register')">Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯</div>
        </div>

        <div id="loginForm">
            <div class="input-group">
                <label>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label>
                <i class="fas fa-phone input-icon"></i>
                <input type="tel" id="loginPhone" class="modern-input" placeholder="01xxxxxxxxx" dir="ltr" style="text-align: right;">
            </div>

            <div class="input-group">
                <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
                <i class="fas fa-lock input-icon"></i>
                <input type="password" id="loginPass" class="modern-input" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
            </div>

            <button class="btn-primary" onclick="login()">Ø¯Ø®ÙˆÙ„ Ø¢Ù…Ù† <i class="fas fa-arrow-left" style="margin-right: 8px;"></i></button>
        </div>

        <div id="registerForm" class="hidden">
            
            <div id="regStep1">
                <label style="display:block; font-size:13px; font-weight:700; margin-bottom:10px; text-align:center;">Ø§Ø®ØªØ± ÙˆØ¸ÙŠÙØªÙƒ</label>
                <div class="roles-grid">
                    <div class="role-option" onclick="selectRole('employee', this)">
                        <i class="fas fa-user-tie"></i> <span>Ù…ÙˆØ¸Ù</span>
                    </div>
                    <div class="role-option" onclick="selectRole('supervisor', this)">
                        <i class="fas fa-user-shield"></i> <span>Ù…Ø´Ø±Ù</span>
                    </div>
                    <div class="role-option" onclick="selectRole('technician', this)">
                        <i class="fas fa-tools"></i> <span>ÙÙ†ÙŠ</span>
                    </div>
                </div>

                <div class="input-group">
                    <label>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ù„Ù„ØªÙØ¹ÙŠÙ„</label>
                    <i class="fas fa-mobile-alt input-icon"></i>
                    <input type="tel" id="regPhone" class="modern-input" placeholder="01xxxxxxxxx" dir="ltr" style="text-align: right;">
                </div>

                <div id="recaptcha-container" style="margin: 10px auto; display: flex; justify-content: center;"></div>
                
                <button id="sendOtpBtn" class="btn-primary" onclick="sendOtp()" disabled>Ø¥Ø±Ø³Ø§Ù„ ÙƒÙˆØ¯ Ø§Ù„ØªÙØ¹ÙŠÙ„</button>

                <div id="otpBox" class="hidden" style="margin-top: 15px;">
                    <div class="input-group">
                        <label>ÙƒÙˆØ¯ Ø§Ù„ØªØ­Ù‚Ù‚ (SMS)</label>
                        <i class="fas fa-sms input-icon"></i>
                        <input type="number" id="otpCode" class="modern-input" placeholder="------" style="text-align: center; letter-spacing: 5px;">
                    </div>
                    <button class="btn-primary" style="background: #10b981;" onclick="verifyOtp()">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø±Ù‚Ù…</button>
                </div>
            </div>

            <div id="regStep2" class="hidden">
                <h3 style="text-align: center; font-size: 18px; margin-bottom: 20px;">Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ğŸ“</h3>
                
                <div class="input-group">
                    <label>Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„</label>
                    <i class="fas fa-user input-icon"></i>
                    <input type="text" id="fullName" class="modern-input" placeholder="Ø§Ù„Ø§Ø³Ù…">
                </div>

                <div class="input-group">
                    <label>Ù…ÙƒØ§Ù† Ø§Ù„Ø¹Ù…Ù„</label>
                    <i class="fas fa-building input-icon"></i>
                    <input type="text" id="workPlace" class="modern-input" placeholder="ÙƒÙ„ÙŠØ© / Ù…Ø¨Ù†Ù‰">
                </div>

                <div class="input-group">
                    <label>Ø¥Ù†Ø´Ø§Ø¡ ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ù‚ÙˆÙŠØ©</label>
                    <i class="fas fa-key input-icon"></i>
                    <input type="password" id="regPass" class="modern-input" placeholder="ÙƒÙ„Ù…Ø© Ø³Ø± Ø¬Ø¯ÙŠØ¯Ø©">
                </div>

                <button class="btn-primary" onclick="completeRegister()">Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨ ÙˆØ¨Ø¯Ø¡ Ø§Ù„Ø¹Ù…Ù„ ğŸš€</button>
            </div>
        </div>

        <div id="statusMsg" class="status-msg"></div>
    </div>

    <div id="appScreen" class="app-card hidden">
        <div class="user-header">
            <div class="user-info">
                <img src="https://cdn-icons-png.flaticon.com/512/3135/3135715.png" class="user-avatar" id="uAvatar">
                <div>
                    <h3 style="margin:0; font-size:16px;" id="uName">Ø¬Ø§Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„...</h3>
                    <span style="font-size:12px; color:#6b7280;" id="uRole"></span>
                </div>
            </div>
            <button class="logout-btn" onclick="logout()">Ø®Ø±ÙˆØ¬</button>
        </div>

        <div id="empView" class="hidden">
            <h2 style="font-size:18px; margin-bottom:15px;">ØªØ³Ø¬ÙŠÙ„ Ø¨Ù„Ø§Øº Ø¬Ø¯ÙŠØ¯</h2>
            
            <div class="upload-zone" onclick="document.getElementById('camInput').click()">
                <i class="fas fa-camera fa-2x" style="color: var(--primary);"></i>
                <p style="margin:10px 0 0; font-size:13px; color:#6b7280;">Ø§Ø¶ØºØ· Ù„Ø§Ù„ØªÙ‚Ø§Ø· Ø£Ùˆ Ø±ÙØ¹ ØµÙˆØ±</p>
            </div>
            <div id="gallery" class="gallery-grid"></div>
            <input type="file" id="camInput" multiple accept="image/*" class="hidden" onchange="previewImages(this)">

            <div class="input-group">
                <input type="text" id="loc" class="modern-input" placeholder="Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¹Ø·Ù„ Ø¨Ø§Ù„ØªÙØµÙŠÙ„" style="padding-right: 15px;">
            </div>
            <div class="input-group">
                <textarea id="desc" class="modern-input" rows="3" placeholder="ÙˆØµÙ Ø§Ù„Ù…Ø´ÙƒÙ„Ø©..." style="padding-right: 15px; border-radius: 14px;"></textarea>
            </div>

            <button class="btn-primary" onclick="submitReport()">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨Ù„Ø§Øº</button>
        </div>

        <div id="supView" class="hidden">
            <h2 style="font-size:18px; margin-bottom:15px;">Ø§Ù„ÙˆØ§Ø±Ø¯ (Ø§Ù„Ø·Ù„Ø¨Ø§Øª)</h2>
            <div id="reportsList" style="text-align:center; color:#999;">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
        </div>

        <div id="appStatus" class="status-msg"></div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, RecaptchaVerifier, signInWithPhoneNumber, createUserWithEmailAndPassword, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, collection, addDoc, onSnapshot, query, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

        // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙØ§ÙŠØ±Ø¨ÙŠØ³
        const firebaseConfig = {
            apiKey: "AIzaSyBojgV1qxSkf16W1gMMjuKm9zF4daDEaFs",
            authDomain: "nursing-attendance.firebaseapp.com",
            databaseURL: "https://nursing-attendance-default-rtdb.firebaseio.com",
            projectId: "nursing-attendance",
            storageBucket: "nursing-attendance.firebasestorage.app",
            messagingSenderId: "935107068390",
            appId: "1:935107068390:web:60c1dad67bfc9125191627"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);
        auth.languageCode = 'ar';

        // Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª
        let selectedRole = '';
        let verifiedPhone = '';

        // 1. Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ø¨ÙŠÙ† Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙˆØ§Ù„ØªØ³Ø¬ÙŠÙ„
        window.setTab = (tab) => {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            if (tab === 'login') {
                document.querySelectorAll('.tab-btn')[0].classList.add('active');
                document.getElementById('loginForm').classList.remove('hidden');
                document.getElementById('registerForm').classList.add('hidden');
            } else {
                document.querySelectorAll('.tab-btn')[1].classList.add('active');
                document.getElementById('loginForm').classList.add('hidden');
                document.getElementById('registerForm').classList.remove('hidden');
                
                // ØªØ¬Ù‡ÙŠØ² Ø§Ù„ÙƒØ§Ø¨ØªØ´Ø§
                if (!window.recaptchaVerifier) {
                    window.recaptchaVerifier = new RecaptchaVerifier(auth, 'recaptcha-container', { 'size': 'normal' });
                    recaptchaVerifier.render();
                }
            }
        };

        // 2. Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙˆØ¸ÙŠÙØ©
        window.selectRole = (role, el) => {
            selectedRole = role;
            document.querySelectorAll('.role-option').forEach(d => d.classList.remove('selected'));
            el.classList.add('selected');
            document.getElementById('sendOtpBtn').disabled = false;
        };

        // 3. Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙƒÙˆØ¯ (ØªØ³Ø¬ÙŠÙ„ Ø¬Ø¯ÙŠØ¯)
        window.sendOtp = () => {
            let raw = document.getElementById('regPhone').value.trim();
            if (raw.startsWith('0')) raw = raw.substring(1);
            verifiedPhone = '+20' + raw;

            const btn = document.getElementById('sendOtpBtn');
            const msg = document.getElementById('statusMsg');
            
            btn.disabled = true;
            msg.innerText = "Ø¬Ø§Ø±ÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙƒÙˆØ¯...";
            msg.style.color = "blue";

            signInWithPhoneNumber(auth, verifiedPhone, window.recaptchaVerifier)
                .then((result) => {
                    window.confirmationResult = result;
                    msg.innerText = "ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ âœ…";
                    msg.style.color = "green";
                    document.getElementById('otpBox').classList.remove('hidden');
                    document.getElementById('sendOtpBtn').classList.add('hidden');
                    document.getElementById('recaptcha-container').classList.add('hidden');
                }).catch((error) => {
                    btn.disabled = false;
                    msg.innerText = error.message;
                    msg.style.color = "red";
                });
        };

        // 4. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ÙƒÙˆØ¯
        window.verifyOtp = () => {
            const code = document.getElementById('otpCode').value;
            window.confirmationResult.confirm(code).then(() => {
                // Ù†Ø¬Ø§Ø­ -> Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ø®Ø·ÙˆØ© ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±
                document.getElementById('regStep1').classList.add('hidden');
                document.getElementById('regStep2').classList.remove('hidden');
                document.getElementById('statusMsg').innerText = "";
            }).catch(() => alert("Ø§Ù„ÙƒÙˆØ¯ ØºÙŠØ± ØµØ­ÙŠØ­!"));
        };

        // 5. Ø¥ØªÙ…Ø§Ù… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ (Ø¥Ù†Ø´Ø§Ø¡ ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±)
        window.completeRegister = async () => {
            const name = document.getElementById('fullName').value;
            const work = document.getElementById('workPlace').value;
            const pass = document.getElementById('regPass').value;

            if(!name || !work || pass.length < 6) {
                alert("ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± 6 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„)");
                return;
            }

            // Ø¥ÙŠÙ…ÙŠÙ„ ÙˆÙ‡Ù…ÙŠ Ù„Ù„Ø±Ø¨Ø· (Ø§Ù„Ø±Ù‚Ù… + @app.com)
            const email = verifiedPhone.replace('+', '') + "@app.com";

            try {
                const cred = await createUserWithEmailAndPassword(auth, email, pass);
                const user = cred.user;

                // Ø­ÙØ¸ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                await setDoc(doc(db, "users", user.uid), {
                    uid: user.uid,
                    phone: verifiedPhone,
                    role: selectedRole,
                    name: name,
                    work: work
                });

                openApp({ name, role: selectedRole });

            } catch (error) {
                alert("Ø®Ø·Ø£: " + error.message);
            }
        };

        // 6. ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ (Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù‚Ø¯ÙŠÙ…)
        window.login = async () => {
            let raw = document.getElementById('loginPhone').value.trim();
            if (raw.startsWith('0')) raw = raw.substring(1);
            const email = "20" + raw + "@app.com";
            const pass = document.getElementById('loginPass').value;

            const msg = document.getElementById('statusMsg');
            msg.innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚...";
            msg.style.color = "blue";

            try {
                const cred = await signInWithEmailAndPassword(auth, email, pass);
                // Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø³ÙŠØ­Ø¯Ø« Ø¹Ø¨Ø± Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨
            } catch (error) {
                msg.innerText = "Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ ØºÙŠØ± ØµØ­ÙŠØ­Ø© âŒ";
                msg.style.color = "red";
            }
        };

        // 7. Ù…Ø±Ø§Ù‚Ø¨ Ø­Ø§Ù„Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                const snap = await getDoc(doc(db, "users", user.uid));
                if (snap.exists()) openApp(snap.data());
            }
        });

        // 8. ÙØªØ­ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
        function openApp(userData) {
            document.getElementById('authScreen').classList.add('hidden');
            document.getElementById('appScreen').classList.remove('hidden');

            document.getElementById('uName').innerText = userData.name;
            let r = "Ù…ÙˆØ¸Ù";
            if(userData.role === 'supervisor') r = "Ù…Ø´Ø±Ù";
            if(userData.role === 'technician') r = "ÙÙ†ÙŠ";
            document.getElementById('uRole').innerText = r;

            if (userData.role === 'employee') {
                document.getElementById('empView').classList.remove('hidden');
            } else if (userData.role === 'supervisor') {
                document.getElementById('supView').classList.remove('hidden');
                loadReports();
            }
        }

        // --- ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ù…ÙˆØ¸Ù ---
        window.previewImages = (input) => {
            const g = document.getElementById('gallery'); g.innerHTML = "";
            for(let f of input.files) {
                let i = document.createElement('img'); i.src = URL.createObjectURL(f); g.appendChild(i);
            }
        };

        window.submitReport = async () => {
            const status = document.getElementById('appStatus');
            const desc = document.getElementById('desc').value;
            
            if(!desc) { alert("Ø£ÙƒØªØ¨ Ø§Ù„ÙˆØµÙ"); return; }
            status.innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø±ÙØ¹..."; status.style.color="blue";

            try {
                const uid = auth.currentUser.uid;
                const uData = (await getDoc(doc(db, "users", uid))).data();

                let urls = [];
                const files = document.getElementById('camInput').files;
                for(let f of files) {
                    const r = ref(storage, 'reports/'+Date.now()+'_'+f.name);
                    await uploadBytes(r, f);
                    urls.push(await getDownloadURL(r));
                }

                await addDoc(collection(db, "maintenance_reports"), {
                    uid, name: uData.name, work: uData.work,
                    desc, loc: document.getElementById('loc').value,
                    images: urls, status: 'new', timestamp: serverTimestamp()
                });

                status.innerText = "ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø¨Ù†Ø¬Ø§Ø­ âœ…";
                status.style.color="green";
                setTimeout(() => { status.innerText=""; document.getElementById('desc').value=""; }, 2000);

            } catch(e) { status.innerText="Ø­Ø¯Ø« Ø®Ø·Ø£"; status.style.color="red"; }
        };

        // --- ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ù…Ø´Ø±Ù ---
        function loadReports() {
            const list = document.getElementById('reportsList');
            const q = query(collection(db, "maintenance_reports"), orderBy("timestamp", "desc"));
            onSnapshot(q, (snap) => {
                list.innerHTML = "";
                if(snap.empty) { list.innerHTML = "<p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨Ù„Ø§ØºØ§Øª</p>"; return; }
                snap.forEach(d => {
                    const data = d.data();
                    let imgs = data.images?.map(u=>`<a href="${u}" target="_blank"><img src="${u}" style="width:50px;height:50px;border-radius:8px;margin:2px;border:1px solid #ddd;"></a>`).join('') || '';
                    
                    let card = `
                    <div style="background:#fff; padding:15px; border-radius:16px; margin-bottom:10px; border:1px solid #eee; text-align:right;">
                        <div style="font-weight:bold; margin-bottom:5px;">${data.name} <span style="background:#e0f2fe; color:#0284c7; padding:2px 8px; border-radius:10px; font-size:11px;">${data.status}</span></div>
                        <div style="font-size:12px; color:#6b7280; margin-bottom:8px;">${data.loc} (${data.work})</div>
                        <p style="margin-bottom:10px; color:#374151;">${data.desc}</p>
                        <div>${imgs}</div>
                    </div>`;
                    list.innerHTML += card;
                });
            });
        }

        window.logout = () => { if(confirm("Ø®Ø±ÙˆØ¬ØŸ")) auth.signOut().then(()=>location.reload()); };
    </script>
</body>
</html>
